<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrestling Match Maker Pro - Material 3</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Flex:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* Material 3 Design Tokens */
        :root {
            /* Primary */
            --md-sys-color-primary: #1a5fb4;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d4e3ff;
            --md-sys-color-on-primary-container: #001c3a;
            
            /* Secondary */
            --md-sys-color-secondary: #545f71;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d8e3f8;
            --md-sys-color-on-secondary-container: #111c2b;
            
            /* Tertiary */
            --md-sys-color-tertiary: #6d5677;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f6d9ff;
            --md-sys-color-on-tertiary-container: #271430;
            
            /* Error */
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            
            /* Surface */
            --md-sys-color-surface: #fdfbff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb;
            --md-sys-color-on-surface-variant: #43474e;
            --md-sys-color-surface-container-lowest: #ffffff;
            --md-sys-color-surface-container-low: #f4f3f7;
            --md-sys-color-surface-container: #efedf1;
            --md-sys-color-surface-container-high: #e9e7ec;
            --md-sys-color-surface-container-highest: #e3e2e6;
            
            /* Outline */
            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c6cf;
            
            /* Inverse */
            --md-sys-color-inverse-surface: #2f3033;
            --md-sys-color-inverse-on-surface: #f1f0f4;
            --md-sys-color-inverse-primary: #a5c8ff;
            
            /* Shadow */
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            
            /* Success (custom) */
            --md-sys-color-success: #386a20;
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-success-container: #b7f397;
            --md-sys-color-on-success-container: #042100;
            
            /* Warning (custom) */
            --md-sys-color-warning: #7d5700;
            --md-sys-color-on-warning: #ffffff;
            --md-sys-color-warning-container: #ffdeab;
            --md-sys-color-on-warning-container: #271900;
        }
        
        * {
            font-family: 'Roboto Flex', 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-size: 14px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
        }
        
        /* M3 Typography */
        .display-large { font-size: 57px; line-height: 64px; font-weight: 400; }
        .display-medium { font-size: 45px; line-height: 52px; font-weight: 400; }
        .display-small { font-size: 36px; line-height: 44px; font-weight: 400; }
        .headline-large { font-size: 32px; line-height: 40px; font-weight: 400; }
        .headline-medium { font-size: 28px; line-height: 36px; font-weight: 400; }
        .headline-small { font-size: 24px; line-height: 32px; font-weight: 400; }
        .title-large { font-size: 22px; line-height: 28px; font-weight: 500; }
        .title-medium { font-size: 16px; line-height: 24px; font-weight: 500; letter-spacing: 0.15px; }
        .title-small { font-size: 14px; line-height: 20px; font-weight: 500; letter-spacing: 0.1px; }
        .body-large { font-size: 16px; line-height: 24px; font-weight: 400; letter-spacing: 0.5px; }
        .body-medium { font-size: 14px; line-height: 20px; font-weight: 400; letter-spacing: 0.25px; }
        .body-small { font-size: 12px; line-height: 16px; font-weight: 400; letter-spacing: 0.4px; }
        .label-large { font-size: 14px; line-height: 20px; font-weight: 500; letter-spacing: 0.1px; }
        .label-medium { font-size: 12px; line-height: 16px; font-weight: 500; letter-spacing: 0.5px; }
        .label-small { font-size: 11px; line-height: 16px; font-weight: 500; letter-spacing: 0.5px; }
        
        /* M3 Elevation */
        .elevation-0 { box-shadow: none; }
        .elevation-1 { box-shadow: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15); }
        .elevation-2 { box-shadow: 0 1px 2px rgba(0,0,0,0.3), 0 2px 6px 2px rgba(0,0,0,0.15); }
        .elevation-3 { box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3); }
        .elevation-4 { box-shadow: 0 6px 10px 4px rgba(0,0,0,0.15), 0 2px 3px rgba(0,0,0,0.3); }
        .elevation-5 { box-shadow: 0 8px 12px 6px rgba(0,0,0,0.15), 0 4px 4px rgba(0,0,0,0.3); }
        
        /* M3 Shape */
        .shape-none { border-radius: 0; }
        .shape-extra-small { border-radius: 4px; }
        .shape-small { border-radius: 8px; }
        .shape-medium { border-radius: 12px; }
        .shape-large { border-radius: 16px; }
        .shape-extra-large { border-radius: 28px; }
        .shape-full { border-radius: 9999px; }
        
        /* M3 Button Base */
        .m3-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 40px;
            padding: 0 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.1px;
            border: none;
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.2, 0, 0, 1);
            text-decoration: none;
            white-space: nowrap;
        }
        
        .m3-btn:disabled {
            opacity: 0.38;
            cursor: not-allowed;
        }
        
        /* M3 Filled Button */
        .m3-btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .m3-btn-filled:hover:not(:disabled) {
            box-shadow: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
        }
        .m3-btn-filled:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        /* M3 Tonal Button */
        .m3-btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        .m3-btn-tonal:hover:not(:disabled) {
            box-shadow: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
        }
        
        /* M3 Outlined Button */
        .m3-btn-outlined {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }
        .m3-btn-outlined:hover:not(:disabled) {
            background-color: var(--md-sys-color-primary);
            background-color: rgba(26, 95, 180, 0.08);
        }
        
        /* M3 Text Button */
        .m3-btn-text {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            padding: 0 12px;
        }
        .m3-btn-text:hover:not(:disabled) {
            background-color: rgba(26, 95, 180, 0.08);
        }
        
        /* M3 FAB */
        .m3-fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3);
            transition: all 200ms cubic-bezier(0.2, 0, 0, 1);
        }
        .m3-fab:hover {
            box-shadow: 0 6px 10px 4px rgba(0,0,0,0.15), 0 2px 3px rgba(0,0,0,0.3);
        }
        
        /* M3 Card */
        .m3-card {
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: 12px;
            padding: 16px;
            transition: all 200ms cubic-bezier(0.2, 0, 0, 1);
        }
        .m3-card-elevated {
            background-color: var(--md-sys-color-surface-container-low);
            box-shadow: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
        }
        .m3-card-filled {
            background-color: var(--md-sys-color-surface-container-highest);
        }
        .m3-card-outlined {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
        }
        
        /* M3 Text Field */
        .m3-text-field {
            position: relative;
            width: 100%;
        }
        .m3-text-field input,
        .m3-text-field select,
        .m3-text-field textarea {
            width: 100%;
            height: 56px;
            padding: 16px;
            padding-top: 24px;
            border: none;
            border-radius: 4px 4px 0 0;
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            outline: none;
            border-bottom: 2px solid var(--md-sys-color-on-surface-variant);
            transition: all 200ms;
        }
        .m3-text-field input:focus,
        .m3-text-field select:focus,
        .m3-text-field textarea:focus {
            border-bottom-color: var(--md-sys-color-primary);
        }
        .m3-text-field label {
            position: absolute;
            left: 16px;
            top: 8px;
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            pointer-events: none;
        }
        .m3-text-field textarea {
            height: auto;
            min-height: 120px;
            resize: vertical;
        }
        
        /* M3 Chip */
        .m3-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            height: 32px;
            padding: 0 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.1px;
            cursor: pointer;
            transition: all 150ms;
        }
        .m3-chip-assist {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-on-surface);
        }
        .m3-chip-filter {
            background-color: var(--md-sys-color-surface-container-low);
            color: var(--md-sys-color-on-surface-variant);
        }
        .m3-chip-filter.selected {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        
        /* M3 Navigation Bar / Tabs */
        .m3-tabs {
            display: flex;
            background-color: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-surface-variant);
        }
        .m3-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            position: relative;
            transition: all 200ms;
            border: none;
            background: transparent;
            min-height: 64px;
        }
        .m3-tab:hover {
            background-color: rgba(26, 95, 180, 0.08);
        }
        .m3-tab.active {
            color: var(--md-sys-color-primary);
        }
        .m3-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 48px;
            height: 3px;
            background-color: var(--md-sys-color-primary);
            border-radius: 3px 3px 0 0;
        }
        .m3-tab-icon {
            font-size: 24px;
        }
        .m3-tab-label {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        /* M3 Dialog/Modal */
        .m3-dialog-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.32);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 150ms ease-out;
        }
        .m3-dialog {
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 28px;
            padding: 24px;
            max-width: 560px;
            width: calc(100% - 48px);
            max-height: calc(100vh - 48px);
            overflow-y: auto;
            box-shadow: 0 8px 12px 6px rgba(0,0,0,0.15), 0 4px 4px rgba(0,0,0,0.3);
            animation: slideUp 200ms cubic-bezier(0.2, 0, 0, 1);
        }
        .m3-dialog-large {
            max-width: 800px;
        }
        .m3-dialog-xl {
            max-width: 1100px;
        }
        .m3-dialog-title {
            font-size: 24px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 16px;
        }
        
        /* M3 Snackbar */
        .m3-snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--md-sys-color-inverse-surface);
            color: var(--md-sys-color-inverse-on-surface);
            padding: 14px 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 344px;
            max-width: 672px;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideUp 200ms cubic-bezier(0.2, 0, 0, 1);
        }
        .m3-snackbar-action {
            color: var(--md-sys-color-inverse-primary);
            background: none;
            border: none;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
        }
        
        /* M3 Progress Indicator */
        .m3-progress {
            height: 4px;
            background-color: var(--md-sys-color-surface-container-highest);
            border-radius: 2px;
            overflow: hidden;
        }
        .m3-progress-bar {
            height: 100%;
            background-color: var(--md-sys-color-primary);
            border-radius: 2px;
            transition: width 300ms cubic-bezier(0.2, 0, 0, 1);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-container);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-outline);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--md-sys-color-on-surface-variant);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .animate-fade-in { animation: fadeIn 200ms ease-out; }
        .animate-slide-up { animation: slideUp 200ms cubic-bezier(0.2, 0, 0, 1); }
        .animate-slide-in { animation: slideIn 200ms cubic-bezier(0.2, 0, 0, 1); }
        
        /* Drag and Drop */
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .drag-over { background-color: var(--md-sys-color-primary-container); }
        
        /* Match/Wrestler Cards */
        .wrestler-card, .match-card {
            transition: all 200ms cubic-bezier(0.2, 0, 0, 1);
        }
        .wrestler-card:hover, .match-card:hover {
            background-color: var(--md-sys-color-surface-container);
        }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        
        /* Icon button */
        .m3-icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: background-color 200ms;
        }
        .m3-icon-btn:hover {
            background-color: var(--md-sys-color-surface-container-highest);
        }
        
        /* Color input styling */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 20px;
        }
        
        /* Segmented Button */
        .m3-segmented-btn-group {
            display: flex;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 20px;
            overflow: hidden;
        }
        .m3-segmented-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            border-right: 1px solid var(--md-sys-color-outline);
        }
        .m3-segmented-btn:last-child {
            border-right: none;
        }
        .m3-segmented-btn.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        .m3-segmented-btn:hover:not(.active) {
            background-color: rgba(26, 95, 180, 0.08);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef, useMemo } = React;
        
        // M3 Snackbar Component
        const Snackbar = ({ message, type = 'info', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            return (
                <div className="m3-snackbar">
                    <span className="material-icons-round" style={{ fontSize: 24 }}>{icons[type]}</span>
                    <span className="flex-1 body-medium">{message}</span>
                    <button className="m3-snackbar-action" onClick={onClose}>Dismiss</button>
                </div>
            );
        };
        
        const SnackbarContainer = ({ toasts, removeToast }) => {
            if (toasts.length === 0) return null;
            const latest = toasts[toasts.length - 1];
            return <Snackbar key={latest.id} {...latest} onClose={() => removeToast(latest.id)} />;
        };
        
        // M3 Dialog Component
        const Dialog = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            
            const sizeClass = size === 'lg' ? 'm3-dialog-large' : size === 'xl' ? 'm3-dialog-xl' : '';
            
            return (
                <div className="m3-dialog-backdrop animate-fade-in" onClick={onClose}>
                    <div className={`m3-dialog ${sizeClass} animate-slide-up custom-scrollbar`} onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="m3-dialog-title">{title}</h2>
                            <button className="m3-icon-btn" onClick={onClose}>
                                <span className="material-icons-round">close</span>
                            </button>
                        </div>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };
        
        // M3 Stat Card Component
        const StatCard = ({ title, value, icon, color = 'primary' }) => {
            const colorStyles = {
                primary: { bg: 'var(--md-sys-color-primary-container)', text: 'var(--md-sys-color-on-primary-container)' },
                secondary: { bg: 'var(--md-sys-color-secondary-container)', text: 'var(--md-sys-color-on-secondary-container)' },
                tertiary: { bg: 'var(--md-sys-color-tertiary-container)', text: 'var(--md-sys-color-on-tertiary-container)' },
                success: { bg: 'var(--md-sys-color-success-container)', text: 'var(--md-sys-color-on-success-container)' },
                warning: { bg: 'var(--md-sys-color-warning-container)', text: 'var(--md-sys-color-on-warning-container)' },
                error: { bg: 'var(--md-sys-color-error-container)', text: 'var(--md-sys-color-on-error-container)' },
            };
            const style = colorStyles[color] || colorStyles.primary;
            
            return (
                <div className="m3-card m3-card-filled" style={{ backgroundColor: style.bg }}>
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="label-medium" style={{ color: style.text, opacity: 0.8 }}>{title}</p>
                            <p className="headline-medium mt-2" style={{ color: style.text }}>{value}</p>
                        </div>
                        <div className="text-3xl" style={{ color: style.text }}>{icon}</div>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [rosters, setRosters] = useState({ t1: [], t2: [], t3: [] });
            const [names, setNames] = useState({ t1: 'Team 1', t2: 'Team 2', t3: 'Team 3' });
            const [abbrevs, setAbbrevs] = useState({ t1: 'T1', t2: 'T2', t3: 'T3' });
            const [colors, setColors] = useState({ t1: '#1a5fb4', t2: '#6d5677', t3: '#386a20' });
            const [matches, setMatches] = useState([]);
            const [scratched, setScratched] = useState([]);
            const [settings, setSettings] = useState({ 
                maxWt: 10, 
                preferredWt: 5,
                maxAge: 1, 
                maxSkill: 2, 
                minMatchesPerWrestler: 2,
                maxPerMat: 25,
                minRestBetweenBouts: 4
            });
            const [tab, setTab] = useState('upload');
            const [teamView, setTeamView] = useState('t1');
            const [selected, setSelected] = useState(null);
            const [dragged, setDragged] = useState(null);
            const [draggedFromMat, setDraggedFromMat] = useState(null);
            const [savedTournaments, setSavedTournaments] = useState([]);
            const [currentTournament, setCurrentTournament] = useState('');
            const [toasts, setToasts] = useState([]);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [filterText, setFilterText] = useState('');
            const [sortBy, setSortBy] = useState('name');
            
            // Modals
            const [showSaveDialog, setShowSaveDialog] = useState(false);
            const [showManageDialog, setShowManageDialog] = useState(false);
            const [showPasteDialog, setShowPasteDialog] = useState(false);
            const [showScratchDialog, setShowScratchDialog] = useState(false);
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [pasteText, setPasteText] = useState('');
            const [pasteTeam, setPasteTeam] = useState('t1');
            const [saveName, setSaveName] = useState('');
            
            // Toast management
            const addToast = useCallback((message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            }, []);
            
            const removeToast = useCallback((id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            }, []);
            
            // Load saved tournaments on mount
            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                setSavedTournaments(Object.keys(saved));
            }, []);
            
            // Auto-save current tournament
            useEffect(() => {
                if (currentTournament) {
                    const state = { rosters, names, abbrevs, colors, matches, scratched, settings };
                    const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                    saved[currentTournament] = { ...state, lastModified: new Date().toISOString() };
                    localStorage.setItem('wrestlingTournaments', JSON.stringify(saved));
                }
            }, [rosters, names, abbrevs, colors, matches, scratched, settings, currentTournament]);
            
            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 's') {
                            e.preventDefault();
                            setShowSaveDialog(true);
                        } else if (e.key === 'z') {
                            e.preventDefault();
                            undo();
                        } else if (e.key === 'y') {
                            e.preventDefault();
                            redo();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [historyIndex]);
            
            const addToHistory = useCallback((state) => {
                setHistory(prev => {
                    const newHistory = prev.slice(0, historyIndex + 1);
                    return [...newHistory, state];
                });
                setHistoryIndex(prev => prev + 1);
            }, [historyIndex]);
            
            const undo = () => {
                if (historyIndex > 0) {
                    const prevState = history[historyIndex - 1];
                    setMatches(prevState.matches);
                    setHistoryIndex(prev => prev - 1);
                    addToast('Undo successful', 'info');
                }
            };
            
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    const nextState = history[historyIndex + 1];
                    setMatches(nextState.matches);
                    setHistoryIndex(prev => prev + 1);
                    addToast('Redo successful', 'info');
                }
            };
            
            const saveNew = () => {
                if (!saveName.trim()) {
                    addToast('Please enter a tournament name', 'error');
                    return;
                }
                const state = { rosters, names, abbrevs, colors, matches, scratched, settings };
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                saved[saveName] = { ...state, lastModified: new Date().toISOString() };
                localStorage.setItem('wrestlingTournaments', JSON.stringify(saved));
                setSavedTournaments(Object.keys(saved));
                setCurrentTournament(saveName);
                setSaveName('');
                setShowSaveDialog(false);
                addToast(`Tournament "${saveName}" saved!`, 'success');
            };
            
            const loadTournament = (name) => {
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                if (saved[name]) {
                    const data = saved[name];
                    setRosters(data.rosters);
                    setNames(data.names);
                    setAbbrevs(data.abbrevs || { t1: 'T1', t2: 'T2', t3: 'T3' });
                    setColors(data.colors);
                    setMatches(data.matches);
                    setScratched(data.scratched || []);
                    setSettings(data.settings);
                    setCurrentTournament(name);
                    addToast(`Loaded "${name}"`, 'success');
                }
            };
            
            const deleteTournament = (name) => {
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                delete saved[name];
                localStorage.setItem('wrestlingTournaments', JSON.stringify(saved));
                setSavedTournaments(Object.keys(saved));
                if (currentTournament === name) setCurrentTournament('');
                addToast(`Deleted "${name}"`, 'info');
            };
            
            const newTournament = () => {
                setRosters({ t1: [], t2: [], t3: [] });
                setNames({ t1: 'Team 1', t2: 'Team 2', t3: 'Team 3' });
                setAbbrevs({ t1: 'T1', t2: 'T2', t3: 'T3' });
                setColors({ t1: '#1a5fb4', t2: '#6d5677', t3: '#386a20' });
                setMatches([]);
                setScratched([]);
                setCurrentTournament('');
                setTab('upload');
                addToast('New tournament created', 'success');
            };
            
            const renumber = (ms) => {
                const byMat = { 1: [], 2: [], 3: [] };
                ms.forEach(m => byMat[m.mat].push(m));
                const result = [];
                [1, 2, 3].forEach(mat => {
                    byMat[mat].sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((m, i) => {
                        result.push({ ...m, num: mat * 100 + i, order: i });
                    });
                });
                return result;
            };
            
            const scratchWrestler = (wrestler) => {
                const team = Object.keys(names).find(k => names[k] === wrestler.Team);
                setRosters(prev => ({
                    ...prev,
                    [team]: prev[team].filter(w => w.Name !== wrestler.Name)
                }));
                
                const updatedMatches = matches.filter(m => 
                    !(m.w1.Name === wrestler.Name && m.w1.Team === wrestler.Team) &&
                    !(m.w2.Name === wrestler.Name && m.w2.Team === wrestler.Team)
                );
                setMatches(renumber(updatedMatches));
                setScratched(prev => [...prev, wrestler]);
                if (selected?.Name === wrestler.Name) setSelected(null);
                addToast(`${wrestler.Name} scratched`, 'warning');
            };
            
            const restoreWrestler = (wrestler) => {
                const team = Object.keys(names).find(k => names[k] === wrestler.Team);
                setRosters(prev => ({
                    ...prev,
                    [team]: [...prev[team], wrestler]
                }));
                setScratched(prev => prev.filter(w => 
                    !(w.Name === wrestler.Name && w.Team === wrestler.Team)
                ));
                addToast(`${wrestler.Name} restored`, 'success');
            };
            
            const calcAge = (dob) => {
                const d = new Date(dob);
                const t = new Date();
                return t.getFullYear() - d.getFullYear();
            };
            
            const parseData = (text) => {
                const errors = [];
                const warnings = [];
                const validRows = [];
                
                const lines = text.trim().split('\n');
                
                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    if (!line.trim()) return;
                    
                    const v = line.split(/[,\t]/).map(x => x.trim());
                    const hasAnyContent = v.some(val => val !== '');
                    if (!hasAnyContent) return;
                    
                    if (index === 0) {
                        const firstValue = v[0]?.toLowerCase();
                        const secondValue = v[1]?.toLowerCase();
                        const thirdValue = v[2]?.toLowerCase();
                        const headerKeywords = ['first', 'name', 'last', 'weight', 'dob', 'birth', 'age', 'exp', 'experience', 'skill', 'level'];
                        const isLikelyHeader = headerKeywords.some(keyword => 
                            firstValue?.includes(keyword) || 
                            secondValue?.includes(keyword) || 
                            thirdValue?.includes(keyword)
                        );
                        if (isLikelyHeader) return;
                    }
                    
                    if (v.length < 6) {
                        errors.push(`Line ${lineNum}: Not enough columns (found ${v.length}, need 6)`);
                        return;
                    }
                    
                    const firstName = v[0];
                    const lastName = v[1];
                    const weight = parseFloat(v[2]);
                    const dob = v[3];
                    const exp = parseInt(v[4]);
                    const skill = parseInt(v[5]);
                    
                    if (!firstName || !lastName) {
                        errors.push(`Line ${lineNum}: Missing name`);
                        return;
                    }
                    
                    if (isNaN(weight) || weight <= 0) {
                        errors.push(`Line ${lineNum}: Invalid weight "${v[2]}"`);
                        return;
                    }
                    if (weight < 30 || weight > 400) {
                        warnings.push(`Line ${lineNum}: Unusual weight ${weight} lbs`);
                    }
                    
                    const dobDate = new Date(dob);
                    if (isNaN(dobDate.getTime())) {
                        errors.push(`Line ${lineNum}: Invalid date "${dob}"`);
                        return;
                    }
                    const age = calcAge(dob);
                    if (age < 4 || age > 25) {
                        warnings.push(`Line ${lineNum}: Unusual age ${age}`);
                    }
                    
                    if (isNaN(exp) || exp < 0) {
                        errors.push(`Line ${lineNum}: Invalid experience "${v[4]}"`);
                        return;
                    }
                    
                    if (isNaN(skill) || skill < 1 || skill > 5) {
                        errors.push(`Line ${lineNum}: Invalid skill "${v[5]}" (must be 1-5)`);
                        return;
                    }
                    
                    validRows.push({
                        FirstName: firstName,
                        LastName: lastName,
                        Weight: weight,
                        DOB: dob,
                        Exp: exp,
                        Skill: skill,
                        Age: age,
                        Name: `${firstName} ${lastName}`
                    });
                });
                
                return { data: validRows, errors, warnings };
            };
            
            const loadFile = (team, e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = new Uint8Array(ev.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false, dateNF: 'mm/dd/yyyy' });
                            const csvLines = jsonData.map(row => {
                                const filteredRow = [];
                                let foundContent = false;
                                for (let i = 0; i < row.length; i++) {
                                    if (!foundContent && (row[i] === null || row[i] === undefined || row[i] === '')) continue;
                                    foundContent = true;
                                    filteredRow.push(row[i] || '');
                                }
                                return filteredRow.join(',');
                            }).join('\n');
                            
                            const result = parseData(csvLines);
                            
                            if (result.errors.length > 0) {
                                addToast(`Errors in ${file.name}`, 'error');
                                e.target.value = '';
                                return;
                            }
                            
                            if (result.warnings.length > 0) {
                                addToast(`${result.warnings.length} warnings - check console`, 'warning');
                                console.warn(result.warnings);
                            }
                            
                            setRosters(p => ({ ...p, [team]: result.data.map(x => ({ ...x, Team: names[team] })) }));
                            addToast(`Loaded ${result.data.length} wrestlers into ${names[team]}`, 'success');
                        } catch (error) {
                            addToast(`Error reading file: ${error.message}`, 'error');
                        }
                        e.target.value = '';
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const result = parseData(ev.target.result);
                            
                            if (result.errors.length > 0) {
                                addToast(`Errors in ${file.name}`, 'error');
                                e.target.value = '';
                                return;
                            }
                            
                            if (result.warnings.length > 0) {
                                addToast(`${result.warnings.length} warnings - check console`, 'warning');
                                console.warn(result.warnings);
                            }
                            
                            setRosters(p => ({ ...p, [team]: result.data.map(x => ({ ...x, Team: names[team] })) }));
                            addToast(`Loaded ${result.data.length} wrestlers into ${names[team]}`, 'success');
                        } catch (error) {
                            addToast(`Error reading file: ${error.message}`, 'error');
                        }
                        e.target.value = '';
                    };
                    reader.readAsText(file);
                }
            };
            
            const handlePaste = () => {
                if (!pasteText.trim()) return;
                
                try {
                    const result = parseData(pasteText);
                    
                    if (result.errors.length > 0) {
                        addToast('Errors in pasted data', 'error');
                        return;
                    }
                    
                    if (result.warnings.length > 0) {
                        addToast(`${result.warnings.length} warnings - check console`, 'warning');
                        console.warn(result.warnings);
                    }
                    
                    setRosters(p => ({ ...p, [pasteTeam]: result.data.map(x => ({ ...x, Team: names[pasteTeam] })) }));
                    setPasteText('');
                    setShowPasteDialog(false);
                    addToast(`Loaded ${result.data.length} wrestlers into ${names[pasteTeam]}`, 'success');
                } catch (error) {
                    addToast(`Error parsing data: ${error.message}`, 'error');
                }
            };
            
            const calcScore = (w1, w2) => {
                const wtDiff = Math.abs(w1.Weight - w2.Weight);
                const wtPct = (wtDiff / Math.min(w1.Weight, w2.Weight)) * 100;
                const ageDiff = Math.abs(w1.Age - w2.Age);
                const skillDiff = Math.abs(w1.Skill - w2.Skill);
                if (wtPct > settings.maxWt || ageDiff > settings.maxAge || skillDiff > settings.maxSkill || w1.Team === w2.Team) return null;
                
                const wtScore = wtPct <= settings.preferredWt ? wtPct * 2 : wtPct * 3;
                return { score: wtScore + skillDiff * 1.5 + ageDiff * 0.5, wtPct, wtDiff, ageDiff, skillDiff };
            };
            
            const generate = () => {
                const all = [...rosters.t1, ...rosters.t2, ...rosters.t3];
                const counts = {};
                all.forEach(w => counts[`${w.Name}-${w.Team}`] = 0);
                
                const possible = [];
                for (let i = 0; i < all.length; i++) {
                    for (let j = i + 1; j < all.length; j++) {
                        const q = calcScore(all[i], all[j]);
                        if (q) {
                            const avgSkill = (all[i].Skill + all[j].Skill) / 2;
                            possible.push({ 
                                w1: all[i], w2: all[j], 
                                w1Key: `${all[i].Name}-${all[i].Team}`, 
                                w2Key: `${all[j].Name}-${all[j].Team}`,
                                avgSkill,
                                ...q 
                            });
                        }
                    }
                }
                possible.sort((a, b) => a.score - b.score);
                
                const assignMat = (match, matCounts) => {
                    const skill = match.avgSkill;
                    if (skill <= 1) {
                        if (matCounts[1] < settings.maxPerMat) return 1;
                        if (matCounts[2] < settings.maxPerMat) return 2;
                        if (matCounts[3] < settings.maxPerMat) return 3;
                    }
                    if (skill <= 3) {
                        if (matCounts[2] < settings.maxPerMat) return 2;
                        if (matCounts[3] < settings.maxPerMat) return 3;
                        if (matCounts[1] < settings.maxPerMat) return 1;
                    }
                    if (matCounts[3] < settings.maxPerMat) return 3;
                    if (matCounts[2] < settings.maxPerMat) return 2;
                    if (matCounts[1] < settings.maxPerMat) return 1;
                    return null;
                };
                
                const result = [];
                const matCounts = { 1: 0, 2: 0, 3: 0 };
                
                for (const m of possible) {
                    if (counts[m.w1Key] >= 3 || counts[m.w2Key] >= 3) continue;
                    if (counts[m.w1Key] === 0 || counts[m.w2Key] === 0) {
                        const mat = assignMat(m, matCounts);
                        if (mat) {
                            result.push({ ...m, mat, num: mat * 100 + matCounts[mat], order: matCounts[mat] });
                            matCounts[mat]++;
                            counts[m.w1Key]++;
                            counts[m.w2Key]++;
                        }
                    }
                }
                
                let iterations = 0;
                const maxIterations = possible.length * 2;
                
                while (iterations < maxIterations) {
                    iterations++;
                    const minMatches = Math.min(...Object.values(counts));
                    if (minMatches >= settings.minMatchesPerWrestler) break;
                    
                    let added = false;
                    for (const m of possible) {
                        if (counts[m.w1Key] >= 3 || counts[m.w2Key] >= 3) continue;
                        if (counts[m.w1Key] < settings.minMatchesPerWrestler || counts[m.w2Key] < settings.minMatchesPerWrestler) {
                            const bothNeed = counts[m.w1Key] < settings.minMatchesPerWrestler && counts[m.w2Key] < settings.minMatchesPerWrestler;
                            const oneAtMin = counts[m.w1Key] === minMatches || counts[m.w2Key] === minMatches;
                            
                            if (bothNeed || oneAtMin) {
                                const mat = assignMat(m, matCounts);
                                if (mat) {
                                    result.push({ ...m, mat, num: mat * 100 + matCounts[mat], order: matCounts[mat] });
                                    matCounts[mat]++;
                                    counts[m.w1Key]++;
                                    counts[m.w2Key]++;
                                    added = true;
                                    break;
                                }
                            }
                        }
                    }
                    if (!added) break;
                    if (Object.values(matCounts).every(c => c >= settings.maxPerMat - 2)) break;
                }
                
                setMatches(result);
                addToHistory({ matches: result });
                setTab('mats');
                addToast(`Generated ${result.length} matches!`, 'success');
            };
            
            const getMatches = (w) => matches.filter(m => (m.w1.Name === w.Name && m.w1.Team === w.Team) || (m.w2.Name === w.Name && m.w2.Team === w.Team));
            
            const delMatch = (num) => {
                const newMatches = renumber(matches.filter(m => m.num !== num));
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
                addToast('Match deleted', 'info');
            };
            
            const addMatch = (w, opp) => {
                const q = calcScore(w, opp);
                if (!q) return;
                const mat = 1;
                const newMatches = renumber([...matches, { w1: w, w2: opp, w1Key: `${w.Name}-${w.Team}`, w2Key: `${opp.Name}-${opp.Team}`, mat, order: matches.filter(m => m.mat === mat).length, ...q }]);
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
                setSelected(null);
                addToast('Match added', 'success');
            };
            
            const moveMat = (num, newMat) => {
                const newMatches = renumber(matches.map(m => m.num === num ? { ...m, mat: newMat, order: matches.filter(x => x.mat === newMat).length } : m));
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
            };
            
            const reorderWithinMat = (mat, fromIndex, toIndex) => {
                const matMatches = matches.filter(m => m.mat === mat).sort((a, b) => a.order - b.order);
                const [removed] = matMatches.splice(fromIndex, 1);
                matMatches.splice(toIndex, 0, removed);
                matMatches.forEach((m, i) => m.order = i);
                const otherMatches = matches.filter(m => m.mat !== mat);
                const newMatches = renumber([...otherMatches, ...matMatches]);
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
            };
            
            const getSuggestions = (w) => {
                const all = [...rosters.t1, ...rosters.t2, ...rosters.t3];
                const current = getMatches(w);
                const matched = new Set(current.map(m => m.w1.Name === w.Name ? m.w2.Name : m.w1.Name));
                return all.filter(x => x.Name !== w.Name && x.Team !== w.Team && !matched.has(x.Name))
                    .map(x => ({ w: x, ...calcScore(w, x) }))
                    .filter(x => x.score)
                    .sort((a, b) => a.score - b.score)
                    .slice(0, 10);
            };
            
            const getColor = (team) => {
                const k = Object.keys(names).find(x => names[x] === team);
                return k ? colors[k] : '#6B7280';
            };
            
            const getAbbrev = (team) => {
                const k = Object.keys(names).find(x => names[x] === team);
                return k ? abbrevs[k] : 'XX';
            };
            
            const handleTeamNameChange = (teamKey, newName) => {
                const oldName = names[teamKey];
                setNames(p => ({ ...p, [teamKey]: newName }));
                setRosters(prev => ({
                    ...prev,
                    [teamKey]: prev[teamKey].map(w => ({ ...w, Team: newName }))
                }));
                setMatches(prev => prev.map(m => ({
                    ...m,
                    w1: m.w1.Team === oldName ? { ...m.w1, Team: newName } : m.w1,
                    w2: m.w2.Team === oldName ? { ...m.w2, Team: newName } : m.w2
                })));
                setScratched(prev => prev.map(w => 
                    w.Team === oldName ? { ...w, Team: newName } : w
                ));
            };
            
            const syncAllTeamNames = () => {
                setRosters(prev => {
                    const updated = {};
                    ['t1', 't2', 't3'].forEach(tk => {
                        updated[tk] = prev[tk].map(w => ({ ...w, Team: names[tk] }));
                    });
                    return updated;
                });
                
                const teamMap = new Map();
                ['t1', 't2', 't3'].forEach(tk => {
                    teamMap.set(tk, names[tk]);
                });
                
                setMatches(prev => prev.map(m => {
                    let w1TeamKey = null;
                    let w2TeamKey = null;
                    
                    ['t1', 't2', 't3'].forEach(tk => {
                        if (rosters[tk].some(w => w.Name === m.w1.Name)) w1TeamKey = tk;
                        if (rosters[tk].some(w => w.Name === m.w2.Name)) w2TeamKey = tk;
                    });
                    
                    return {
                        ...m,
                        w1: w1TeamKey ? { ...m.w1, Team: names[w1TeamKey] } : m.w1,
                        w2: w2TeamKey ? { ...m.w2, Team: names[w2TeamKey] } : m.w2
                    };
                }));
                
                setScratched(prev => prev.map(w => {
                    let teamKey = null;
                    ['t1', 't2', 't3'].forEach(tk => {
                        if (rosters[tk].some(wr => wr.Name === w.Name)) teamKey = tk;
                    });
                    return teamKey ? { ...w, Team: names[teamKey] } : w;
                }));
            };
            
            useEffect(() => {
                if (matches.length > 0 || rosters.t1.length > 0 || rosters.t2.length > 0 || rosters.t3.length > 0) {
                    syncAllTeamNames();
                }
            }, [names]);
            
            const needsRestHighlight = (wrestler, matchNum, mat) => {
                const wrestlerMatches = matches
                    .filter(m => m.mat === mat)
                    .filter(m => (m.w1.Name === wrestler.Name && m.w1.Team === wrestler.Team) || 
                                 (m.w2.Name === wrestler.Name && m.w2.Team === wrestler.Team))
                    .sort((a, b) => a.order - b.order);
                
                if (wrestlerMatches.length < 2) return false;
                
                for (let i = 0; i < wrestlerMatches.length - 1; i++) {
                    const gap = wrestlerMatches[i + 1].order - wrestlerMatches[i].order;
                    if (gap <= settings.minRestBetweenBouts) {
                        if (wrestlerMatches[i].num === matchNum || wrestlerMatches[i + 1].num === matchNum) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                
                ['t1', 't2', 't3'].forEach(tk => {
                    if (!rosters[tk].length) return;
                    
                    const data = [['Age', 'Weight', 'Skill', '', `${names[tk]} (${abbrevs[tk]})`]];
                    rosters[tk].sort((a, b) => a.LastName.localeCompare(b.LastName)).forEach(w => {
                        const ms = getMatches(w).sort((a, b) => a.num - b.num);
                        const row = [w.Age, w.Weight, w.Skill, '', `${w.LastName}, ${w.FirstName}`];
                        ms.forEach(m => {
                            const opp = m.w1.Name === w.Name ? m.w2 : m.w1;
                            const oppTeamKey = Object.keys(names).find(k => names[k] === opp.Team);
                            const oppAbbrev = oppTeamKey ? abbrevs[oppTeamKey] : 'XX';
                            row.push(m.num, `${oppAbbrev}-${opp.FirstName.charAt(0)} ${opp.LastName}`);
                        });
                        data.push(row);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{ wch: 5 }, { wch: 8 }, { wch: 5 }, { wch: 2 }, { wch: 25 }, { wch: 8 }, { wch: 18 }];
                    ws['!margins'] = { left: 0.5, right: 0.5, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3 };
                    ws['!autofilter'] = { ref: ws['!ref'] };
                    ws['!pageSetup'] = { paperSize: 1, orientation: 'portrait', scale: 100, fitToWidth: 1, fitToHeight: 0, fitToPage: true };
                    ws['!rows'] = [{ hpt: 20, hpx: 20 }];
                    ws['!printHeader'] = 'A1:G1';
                    
                    XLSX.utils.book_append_sheet(wb, ws, abbrevs[tk]);
                });
                
                [1, 2, 3].forEach(mat => {
                    const ms = matches.filter(m => m.mat === mat).sort((a, b) => a.num - b.num);
                    if (!ms.length) return;
                    
                    const data = [['Match #', 'Team 1', 'Wrestler 1', 'Team 2', 'Wrestler 2']];
                    ms.forEach(m => {
                        const team1Key = Object.keys(names).find(k => names[k] === m.w1.Team);
                        const team2Key = Object.keys(names).find(k => names[k] === m.w2.Team);
                        const abbrev1 = team1Key ? abbrevs[team1Key] : 'XX';
                        const abbrev2 = team2Key ? abbrevs[team2Key] : 'XX';
                        data.push([m.num, abbrev1, m.w1.Name, abbrev2, m.w2.Name]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{ wch: 10 }, { wch: 8 }, { wch: 25 }, { wch: 8 }, { wch: 25 }];
                    ws['!margins'] = { left: 0.5, right: 0.5, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3 };
                    ws['!pageSetup'] = { paperSize: 1, orientation: 'portrait', scale: 100, fitToWidth: 1, fitToHeight: 0, fitToPage: true, horizontalCentered: true };
                    ws['!rows'] = [{ hpt: 20, hpx: 20 }];
                    ws['!printHeader'] = 'A1:E1';
                    ws['!autofilter'] = { ref: ws['!ref'] };
                    
                    XLSX.utils.book_append_sheet(wb, ws, `Mat ${mat}`);
                });
                
                const fileName = currentTournament ? `${currentTournament}.xlsx` : 'wrestling_matches.xlsx';
                XLSX.writeFile(wb, fileName);
                addToast('Excel file downloaded!', 'success');
            };
            
            const analytics = useMemo(() => {
                const all = [...rosters.t1, ...rosters.t2, ...rosters.t3];
                const matchCounts = {};
                all.forEach(w => matchCounts[`${w.Name}-${w.Team}`] = 0);
                matches.forEach(m => {
                    matchCounts[m.w1Key]++;
                    matchCounts[m.w2Key]++;
                });
                
                const distribution = { 0: 0, 1: 0, 2: 0, 3: 0, '4+': 0 };
                Object.values(matchCounts).forEach(count => {
                    if (count >= 4) distribution['4+']++;
                    else distribution[count]++;
                });
                
                const qualityScores = matches.map(m => {
                    let score = 0;
                    if (m.wtPct <= 5) score += 3;
                    else if (m.wtPct <= 10) score += 2;
                    else score += 1;
                    if (m.ageDiff === 0) score += 2;
                    else if (m.ageDiff === 1) score += 1;
                    if (m.skillDiff === 0) score += 2;
                    else if (m.skillDiff <= 2) score += 1;
                    return score;
                });
                
                const avgQuality = qualityScores.length > 0 
                    ? (qualityScores.reduce((a, b) => a + b, 0) / qualityScores.length).toFixed(1)
                    : 0;
                
                const restViolations = matches.filter(m => {
                    return needsRestHighlight(m.w1, m.num, m.mat) || needsRestHighlight(m.w2, m.num, m.mat);
                }).length;
                
                return {
                    totalWrestlers: all.length,
                    totalMatches: matches.length,
                    distribution,
                    avgMatchesPerWrestler: all.length > 0 ? (matches.length * 2 / all.length).toFixed(1) : 0,
                    avgQuality,
                    restViolations,
                    matCounts: {
                        1: matches.filter(m => m.mat === 1).length,
                        2: matches.filter(m => m.mat === 2).length,
                        3: matches.filter(m => m.mat === 3).length
                    }
                };
            }, [rosters, matches, settings]);
            
            const total = rosters.t1.length + rosters.t2.length + rosters.t3.length;
            
            const getFilteredRoster = (teamKey) => {
                let filtered = rosters[teamKey].filter(w => 
                    w.Name.toLowerCase().includes(filterText.toLowerCase())
                );
                
                switch(sortBy) {
                    case 'name':
                        filtered.sort((a, b) => a.LastName.localeCompare(b.LastName));
                        break;
                    case 'weight':
                        filtered.sort((a, b) => a.Weight - b.Weight);
                        break;
                    case 'skill':
                        filtered.sort((a, b) => b.Skill - a.Skill);
                        break;
                    case 'matches':
                        filtered.sort((a, b) => getMatches(b).length - getMatches(a).length);
                        break;
                }
                
                return filtered;
            };
            
            return (
                <div className="min-h-screen" style={{ backgroundColor: 'var(--md-sys-color-surface)' }}>
                    <SnackbarContainer toasts={toasts} removeToast={removeToast} />
                    
                    <div className="max-w-7xl mx-auto">
                        {/* App Bar */}
                        <header className="elevation-2 animate-slide-in" style={{ backgroundColor: 'var(--md-sys-color-surface)' }}>
                            <div className="px-4 py-4">
                                <div className="flex justify-between items-center flex-wrap gap-4">
                                    <div>
                                        <h1 className="headline-medium" style={{ color: 'var(--md-sys-color-on-surface)' }}>
                                            Wrestling Match Maker
                                        </h1>
                                        <p className="body-medium mt-1" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                            {currentTournament ? (
                                                <span className="flex items-center gap-2">
                                                    <span className="material-icons-round" style={{ fontSize: 16, color: 'var(--md-sys-color-success)' }}>sync</span>
                                                    {currentTournament} (auto-saving)
                                                </span>
                                            ) : 'Smart pairing for 2-3 team scrambles'}
                                        </p>
                                    </div>
                                    <div className="flex gap-2 flex-wrap items-center">
                                        <button onClick={newTournament} className="m3-btn m3-btn-tonal">
                                            <span className="material-icons-round" style={{ fontSize: 18 }}>add</span>
                                            New
                                        </button>
                                        <button onClick={() => setShowSaveDialog(true)} className="m3-btn m3-btn-tonal">
                                            <span className="material-icons-round" style={{ fontSize: 18 }}>save</span>
                                            Save
                                        </button>
                                        {savedTournaments.length > 0 && (
                                            <>
                                                <select 
                                                    onChange={(e) => e.target.value && loadTournament(e.target.value)} 
                                                    className="m3-btn m3-btn-outlined"
                                                    style={{ minWidth: 120 }}
                                                >
                                                    <option value="">Load...</option>
                                                    {savedTournaments.map(name => (
                                                        <option key={name} value={name}>{name}</option>
                                                    ))}
                                                </select>
                                                <button onClick={() => setShowManageDialog(true)} className="m3-btn m3-btn-outlined">
                                                    <span className="material-icons-round" style={{ fontSize: 18 }}>settings</span>
                                                </button>
                                            </>
                                        )}
                                        {scratched.length > 0 && (
                                            <button 
                                                onClick={() => setShowScratchDialog(true)} 
                                                className="m3-btn"
                                                style={{ backgroundColor: 'var(--md-sys-color-warning-container)', color: 'var(--md-sys-color-on-warning-container)' }}
                                            >
                                                <span className="material-icons-round" style={{ fontSize: 18 }}>warning</span>
                                                Scratches ({scratched.length})
                                            </button>
                                        )}
                                        {matches.length > 0 && (
                                            <>
                                                <button onClick={() => setShowAnalytics(true)} className="m3-btn m3-btn-tonal">
                                                    <span className="material-icons-round" style={{ fontSize: 18 }}>analytics</span>
                                                    Analytics
                                                </button>
                                                <button 
                                                    onClick={exportExcel} 
                                                    className="m3-btn"
                                                    style={{ backgroundColor: 'var(--md-sys-color-success-container)', color: 'var(--md-sys-color-on-success-container)' }}
                                                >
                                                    <span className="material-icons-round" style={{ fontSize: 18 }}>download</span>
                                                    Export
                                                </button>
                                            </>
                                        )}
                                        {historyIndex > 0 && (
                                            <button onClick={undo} className="m3-icon-btn" title="Undo (Ctrl+Z)">
                                                <span className="material-icons-round">undo</span>
                                            </button>
                                        )}
                                        {historyIndex < history.length - 1 && (
                                            <button onClick={redo} className="m3-icon-btn" title="Redo (Ctrl+Y)">
                                                <span className="material-icons-round">redo</span>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* M3 Navigation Tabs */}
                            <nav className="m3-tabs">
                                <button onClick={() => setTab('upload')} className={`m3-tab ${tab === 'upload' ? 'active' : ''}`}>
                                    <span className="material-icons-round m3-tab-icon">upload_file</span>
                                    <span className="m3-tab-label">Upload</span>
                                </button>
                                <button onClick={() => setTab('settings')} className={`m3-tab ${tab === 'settings' ? 'active' : ''}`}>
                                    <span className="material-icons-round m3-tab-icon">tune</span>
                                    <span className="m3-tab-label">Settings</span>
                                </button>
                                <button onClick={() => setTab('teams')} disabled={!matches.length} className={`m3-tab ${tab === 'teams' ? 'active' : ''}`} style={!matches.length ? { opacity: 0.38 } : {}}>
                                    <span className="material-icons-round m3-tab-icon">groups</span>
                                    <span className="m3-tab-label">Teams {matches.length > 0 && `(${matches.length})`}</span>
                                </button>
                                <button onClick={() => setTab('mats')} disabled={!matches.length} className={`m3-tab ${tab === 'mats' ? 'active' : ''}`} style={!matches.length ? { opacity: 0.38 } : {}}>
                                    <span className="material-icons-round m3-tab-icon">sports_martial_arts</span>
                                    <span className="m3-tab-label">Mats</span>
                                </button>
                            </nav>
                        </header>
                        
                        {/* Content */}
                        <main className="p-4 animate-fade-in">
                            {tab === 'upload' && (
                                <div className="space-y-4">
                                    <div className="m3-card m3-card-outlined p-4" style={{ borderLeftWidth: 4, borderLeftColor: 'var(--md-sys-color-primary)' }}>
                                        <p className="body-medium" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                            <strong>Format:</strong> FirstName, LastName, Weight, DOB(MM/DD/YYYY), Experience, Skill (1-5)
                                        </p>
                                    </div>
                                    
                                    <div className="flex justify-end">
                                        <button onClick={() => setShowPasteDialog(true)} className="m3-btn m3-btn-filled">
                                            <span className="material-icons-round" style={{ fontSize: 18 }}>content_paste</span>
                                            Paste Data
                                        </button>
                                    </div>
                                    
                                    {['t1', 't2', 't3'].map((tk) => (
                                        <div key={tk} className="m3-card m3-card-outlined p-6">
                                            <div className="flex items-center justify-between mb-4 gap-4 flex-wrap">
                                                <div className="flex items-center gap-3 flex-1 min-w-[200px]">
                                                    <div className="m3-text-field flex-1">
                                                        <label>Team Name</label>
                                                        <input 
                                                            type="text" 
                                                            value={names[tk]} 
                                                            onChange={(e) => handleTeamNameChange(tk, e.target.value)} 
                                                        />
                                                    </div>
                                                    <div className="m3-text-field" style={{ width: 80 }}>
                                                        <label>Abbrev</label>
                                                        <input 
                                                            type="text" 
                                                            value={abbrevs[tk]} 
                                                            onChange={(e) => setAbbrevs(p => ({ ...p, [tk]: e.target.value.substring(0, 3).toUpperCase() }))} 
                                                            maxLength="3"
                                                            style={{ textAlign: 'center' }}
                                                        />
                                                    </div>
                                                    <div className="flex flex-col items-center gap-1">
                                                        <span className="label-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>Color</span>
                                                        <input 
                                                            type="color" 
                                                            value={colors[tk]} 
                                                            onChange={(e) => setColors(p => ({ ...p, [tk]: e.target.value }))} 
                                                        />
                                                    </div>
                                                </div>
                                                <div className="display-small" style={{ color: 'var(--md-sys-color-outline)' }}>{rosters[tk].length}</div>
                                            </div>
                                            <label className="block cursor-pointer">
                                                <div 
                                                    className="flex items-center justify-center gap-3 px-6 py-6 rounded-xl border-2 border-dashed transition-all"
                                                    style={{ 
                                                        borderColor: 'var(--md-sys-color-outline-variant)',
                                                        backgroundColor: 'var(--md-sys-color-surface-container-low)'
                                                    }}
                                                >
                                                    <span className="material-icons-round" style={{ fontSize: 32, color: 'var(--md-sys-color-primary)' }}>cloud_upload</span>
                                                    <span className="title-medium" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>Upload CSV/Excel</span>
                                                </div>
                                                <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => loadFile(tk, e)} className="hidden" />
                                            </label>
                                            {rosters[tk].length > 0 && (
                                                <div className="mt-3 p-3 shape-small flex items-center gap-2" style={{ backgroundColor: 'var(--md-sys-color-success-container)' }}>
                                                    <span className="material-icons-round" style={{ color: 'var(--md-sys-color-on-success-container)' }}>check_circle</span>
                                                    <span className="label-large" style={{ color: 'var(--md-sys-color-on-success-container)' }}>{rosters[tk].length} wrestlers loaded</span>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    
                                    <button 
                                        onClick={generate} 
                                        disabled={!total} 
                                        className="m3-btn m3-btn-filled w-full"
                                        style={{ height: 56 }}
                                    >
                                        <span className="material-icons-round">auto_awesome</span>
                                        <span className="title-medium">Generate Matchups</span>
                                    </button>
                                </div>
                            )}
                            
                            {tab === 'settings' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="m3-text-field">
                                            <label>Max Weight Difference (%)</label>
                                            <input 
                                                type="number" 
                                                value={settings.maxWt} 
                                                onChange={(e) => setSettings(p => ({ ...p, maxWt: parseFloat(e.target.value) }))} 
                                            />
                                        </div>
                                        <div className="m3-text-field">
                                            <label>Preferred Weight Difference (%)</label>
                                            <input 
                                                type="number" 
                                                value={settings.preferredWt} 
                                                onChange={(e) => setSettings(p => ({ ...p, preferredWt: parseFloat(e.target.value) }))} 
                                            />
                                        </div>
                                        <div className="m3-text-field">
                                            <label>Max Age Difference (years)</label>
                                            <input 
                                                type="number" 
                                                value={settings.maxAge} 
                                                onChange={(e) => setSettings(p => ({ ...p, maxAge: parseInt(e.target.value) }))} 
                                            />
                                        </div>
                                        <div className="m3-text-field">
                                            <label>Max Skill Difference</label>
                                            <input 
                                                type="number" 
                                                value={settings.maxSkill} 
                                                onChange={(e) => setSettings(p => ({ ...p, maxSkill: parseInt(e.target.value) }))} 
                                            />
                                        </div>
                                        <div className="m3-text-field">
                                            <label>Min Matches per Wrestler</label>
                                            <input 
                                                type="number" 
                                                value={settings.minMatchesPerWrestler} 
                                                onChange={(e) => setSettings(p => ({ ...p, minMatchesPerWrestler: parseInt(e.target.value) }))} 
                                            />
                                        </div>
                                        <div className="m3-text-field">
                                            <label>Max Matches per Mat</label>
                                            <input 
                                                type="number" 
                                                value={settings.maxPerMat} 
                                                onChange={(e) => setSettings(p => ({ ...p, maxPerMat: parseInt(e.target.value) }))} 
                                            />
                                        </div>
                                        <div className="m3-text-field md:col-span-2">
                                            <label>Min Rest Between Bouts (matches)</label>
                                            <input 
                                                type="number" 
                                                value={settings.minRestBetweenBouts} 
                                                onChange={(e) => setSettings(p => ({ ...p, minRestBetweenBouts: parseInt(e.target.value) }))} 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="m3-card m3-card-filled p-6" style={{ backgroundColor: 'var(--md-sys-color-primary-container)' }}>
                                        <h3 className="title-large mb-4" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>
                                            <span className="material-icons-round" style={{ verticalAlign: 'middle', marginRight: 8 }}>rule</span>
                                            Current Rules Summary
                                        </h3>
                                        <div className="space-y-2" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>
                                            <p className="body-large"> Weight within {settings.maxWt}% (prefer {settings.preferredWt}%)</p>
                                            <p className="body-large"> Age within {settings.maxAge} year(s)</p>
                                            <p className="body-large"> Skill within {settings.maxSkill} points</p>
                                            <p className="body-large"> Each wrestler gets {settings.minMatchesPerWrestler}-3 matches</p>
                                            <p className="body-large"> Maximum {settings.maxPerMat} matches per mat</p>
                                            <p className="body-large"> Minimum {settings.minRestBetweenBouts} matches rest between bouts</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tab === 'teams' && matches.length > 0 && (
                                <div>
                                    {/* Team Selector Chips */}
                                    <div className="flex gap-2 mb-4 flex-wrap">
                                        {['t1', 't2', 't3'].map(tk => rosters[tk].length > 0 && (
                                            <button 
                                                key={tk} 
                                                onClick={() => setTeamView(tk)} 
                                                className={`m3-chip ${teamView === tk ? 'm3-chip-filter selected' : 'm3-chip-filter'}`}
                                                style={teamView === tk ? { backgroundColor: colors[tk] + '30', borderColor: colors[tk], border: '1px solid' } : {}}
                                            >
                                                <span style={{ width: 8, height: 8, borderRadius: 4, backgroundColor: colors[tk] }}></span>
                                                {abbrevs[tk]} - {names[tk]} ({rosters[tk].length})
                                            </button>
                                        ))}
                                    </div>
                                    
                                    {/* Search and Sort */}
                                    <div className="flex gap-4 mb-4 flex-wrap">
                                        <div className="m3-text-field flex-1" style={{ minWidth: 200 }}>
                                            <label>Search wrestlers</label>
                                            <input
                                                type="text"
                                                value={filterText}
                                                onChange={(e) => setFilterText(e.target.value)}
                                            />
                                        </div>
                                        <div className="m3-text-field" style={{ width: 180 }}>
                                            <label>Sort by</label>
                                            <select value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
                                                <option value="name">Name</option>
                                                <option value="weight">Weight</option>
                                                <option value="skill">Skill</option>
                                                <option value="matches">Matches</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-12 gap-4">
                                        {/* Wrestler List */}
                                        <div className="col-span-12 lg:col-span-5 space-y-1 overflow-y-auto custom-scrollbar" style={{ maxHeight: 'calc(100vh - 320px)' }}>
                                            {getFilteredRoster(teamView).map(w => {
                                                const ms = getMatches(w);
                                                const c = getColor(w.Team);
                                                return (
                                                    <div 
                                                        key={w.Name} 
                                                        className={`m3-card m3-card-outlined wrestler-card p-3 cursor-pointer`}
                                                        style={{ 
                                                            borderLeftWidth: 4, 
                                                            borderLeftColor: c,
                                                            backgroundColor: selected?.Name === w.Name ? 'var(--md-sys-color-secondary-container)' : 'var(--md-sys-color-surface)'
                                                        }}
                                                    >
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex-1" onClick={() => setSelected(w)}>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="label-medium px-2 py-1 shape-small" style={{ backgroundColor: c, color: 'white' }}>
                                                                        {getAbbrev(w.Team)}
                                                                    </span>
                                                                    <span className="title-small" style={{ color: c }}>{w.Name}</span>
                                                                    <span className="body-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{w.Weight}lb  {w.Age}y  S{w.Skill}</span>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="title-large" style={{ color: c }}>{ms.length}</span>
                                                                <button onClick={(e) => { e.stopPropagation(); scratchWrestler(w); }} className="m3-icon-btn" style={{ width: 32, height: 32 }}>
                                                                    <span className="material-icons-round" style={{ fontSize: 18, color: 'var(--md-sys-color-error)' }}>close</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        {ms.length > 0 && (
                                                            <div className="mt-2 space-y-1">
                                                                {ms.map(m => {
                                                                    const opp = m.w1.Name === w.Name ? m.w2 : m.w1;
                                                                    const oc = getColor(opp.Team);
                                                                    return (
                                                                        <div key={m.num} className="flex items-center justify-between p-2 shape-small" style={{ backgroundColor: oc + '15' }}>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="label-small" style={{ color: 'var(--md-sys-color-outline)' }}>#{m.num}</span>
                                                                                <span className="label-small px-1 shape-extra-small" style={{ backgroundColor: oc, color: 'white' }}>{getAbbrev(opp.Team)}</span>
                                                                                <span className="body-small" style={{ color: oc }}>{opp.Name}</span>
                                                                            </div>
                                                                            <div className="flex items-center gap-1">
                                                                                <span className={`label-small px-2 py-0.5 shape-full`} style={{ backgroundColor: m.wtPct <= 5 ? 'var(--md-sys-color-success-container)' : m.wtPct <= 10 ? 'var(--md-sys-color-warning-container)' : 'var(--md-sys-color-error-container)' }}>
                                                                                    {m.wtPct.toFixed(0)}%
                                                                                </span>
                                                                                <button onClick={(e) => { e.stopPropagation(); delMatch(m.num); }} className="m3-icon-btn" style={{ width: 24, height: 24 }}>
                                                                                    <span className="material-icons-round" style={{ fontSize: 16, color: 'var(--md-sys-color-error)' }}>close</span>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        
                                        {/* Suggestions Panel */}
                                        <div className="col-span-12 lg:col-span-7">
                                            {selected ? (
                                                <div className="space-y-4">
                                                    <div className="m3-card m3-card-filled p-4" style={{ backgroundColor: 'var(--md-sys-color-primary-container)' }}>
                                                        <h3 className="title-medium" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>
                                                            <span className="material-icons-round" style={{ verticalAlign: 'middle', marginRight: 8 }}>person_search</span>
                                                            Suggested Opponents for {selected.Name}
                                                        </h3>
                                                        <p className="body-small mt-1" style={{ color: 'var(--md-sys-color-on-primary-container)', opacity: 0.8 }}>Click to add match</p>
                                                    </div>
                                                    
                                                    <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar">
                                                        {getSuggestions(selected).map(({ w, wtPct, skillDiff }) => {
                                                            const c = getColor(w.Team);
                                                            return (
                                                                <div 
                                                                    key={w.Name} 
                                                                    onClick={() => addMatch(selected, w)} 
                                                                    className="m3-card m3-card-outlined p-4 cursor-pointer match-card"
                                                                >
                                                                    <div className="flex justify-between items-start">
                                                                        <div>
                                                                            <div className="flex items-center gap-2 mb-1">
                                                                                <span className="label-medium px-2 py-1 shape-small" style={{ backgroundColor: c, color: 'white' }}>{getAbbrev(w.Team)}</span>
                                                                                <span className="title-medium" style={{ color: c }}>{w.Name}</span>
                                                                            </div>
                                                                            <p className="body-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{w.Weight} lbs  Age {w.Age}  Skill {w.Skill}</p>
                                                                        </div>
                                                                        <div className="flex gap-2">
                                                                            <span className={`label-medium px-3 py-1 shape-full`} style={{ backgroundColor: wtPct <= 5 ? 'var(--md-sys-color-success-container)' : 'var(--md-sys-color-warning-container)' }}>
                                                                                Wt: {wtPct.toFixed(1)}%
                                                                            </span>
                                                                            <span className={`label-medium px-3 py-1 shape-full`} style={{ backgroundColor: skillDiff === 0 ? 'var(--md-sys-color-success-container)' : 'var(--md-sys-color-warning-container)' }}>
                                                                                Skill: {skillDiff}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="h-full flex items-center justify-center" style={{ minHeight: 300, color: 'var(--md-sys-color-outline)' }}>
                                                    <div className="text-center">
                                                        <span className="material-icons-round" style={{ fontSize: 64 }}>touch_app</span>
                                                        <p className="title-medium mt-2">Select a wrestler to manage matchups</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tab === 'mats' && matches.length > 0 && (
                                <div>
                                    <div className="m3-card m3-card-outlined p-3 mb-4" style={{ borderLeftWidth: 4, borderLeftColor: 'var(--md-sys-color-warning)' }}>
                                        <div className="flex items-center gap-2">
                                            <span className="material-icons-round" style={{ color: 'var(--md-sys-color-warning)' }}>warning</span>
                                            <span className="body-medium">Orange highlight = wrestlers within {settings.minRestBetweenBouts} matches of each other</span>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 overflow-y-auto custom-scrollbar" style={{ maxHeight: 'calc(100vh - 280px)' }}>
                                        {[1, 2, 3].map(mat => {
                                            const ms = matches.filter(m => m.mat === mat).sort((a, b) => a.order - b.order);
                                            return (
                                                <div 
                                                    key={mat} 
                                                    className="m3-card m3-card-outlined overflow-hidden"
                                                    style={{ padding: 0 }}
                                                    onDragOver={(e) => e.preventDefault()} 
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        if (dragged) {
                                                            if (draggedFromMat !== mat) {
                                                                moveMat(dragged.num, mat);
                                                            }
                                                            setDragged(null);
                                                            setDraggedFromMat(null);
                                                        }
                                                    }}
                                                >
                                                    <div className="p-3 flex justify-between items-center" style={{ backgroundColor: 'var(--md-sys-color-primary)', color: 'var(--md-sys-color-on-primary)' }}>
                                                        <span className="title-medium">
                                                            <span className="material-icons-round" style={{ verticalAlign: 'middle', marginRight: 8, fontSize: 20 }}>sports_martial_arts</span>
                                                            Mat {mat}
                                                        </span>
                                                        <span className="label-large">{ms.length}</span>
                                                    </div>
                                                    <div className="p-2 space-y-1 min-h-[100px]" style={{ backgroundColor: 'var(--md-sys-color-surface-container-low)' }}>
                                                        {ms.map((m, index) => {
                                                            const c1 = getColor(m.w1.Team);
                                                            const c2 = getColor(m.w2.Team);
                                                            const w1NeedsRest = needsRestHighlight(m.w1, m.num, mat);
                                                            const w2NeedsRest = needsRestHighlight(m.w2, m.num, mat);
                                                            const anyNeedsRest = w1NeedsRest || w2NeedsRest;
                                                            
                                                            return (
                                                                <div 
                                                                    key={m.num} 
                                                                    draggable 
                                                                    onDragStart={() => { setDragged(m); setDraggedFromMat(mat); }} 
                                                                    onDragEnd={() => { setDragged(null); setDraggedFromMat(null); }}
                                                                    onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                                                    onDrop={(e) => {
                                                                        e.preventDefault();
                                                                        e.stopPropagation();
                                                                        if (dragged) {
                                                                            if (draggedFromMat !== mat) {
                                                                                moveMat(dragged.num, mat);
                                                                            } else if (dragged.num !== m.num) {
                                                                                const fromIndex = ms.findIndex(x => x.num === dragged.num);
                                                                                const toIndex = index;
                                                                                reorderWithinMat(mat, fromIndex, toIndex);
                                                                            }
                                                                        }
                                                                    }}
                                                                    className={`m3-card match-card p-2 cursor-grab ${dragged?.num === m.num ? 'dragging' : ''}`}
                                                                    style={{ 
                                                                        backgroundColor: anyNeedsRest ? 'var(--md-sys-color-warning-container)' : 'var(--md-sys-color-surface)',
                                                                        border: anyNeedsRest ? '1px solid var(--md-sys-color-warning)' : '1px solid var(--md-sys-color-outline-variant)'
                                                                    }}
                                                                >
                                                                    <div className="flex items-center justify-between mb-1">
                                                                        <div className="flex items-center gap-1">
                                                                            <span className="material-icons-round" style={{ fontSize: 16, color: 'var(--md-sys-color-outline)' }}>drag_indicator</span>
                                                                            <span className="label-medium px-2 py-0.5 shape-small" style={{ backgroundColor: 'var(--md-sys-color-surface-container-highest)' }}>#{m.num}</span>
                                                                        </div>
                                                                        {anyNeedsRest && <span className="material-icons-round" style={{ fontSize: 16, color: 'var(--md-sys-color-warning)' }}>warning</span>}
                                                                    </div>
                                                                    <div className="flex gap-1">
                                                                        <div className="flex-1 p-1 shape-small" style={{ backgroundColor: c1 + '20', borderLeft: `3px solid ${c1}` }}>
                                                                            <div className="flex items-center gap-1">
                                                                                <span className="label-small px-1 shape-extra-small" style={{ backgroundColor: c1, color: 'white' }}>{getAbbrev(m.w1.Team)}</span>
                                                                                <span className="label-small" style={{ color: c1 }}>{m.w1.Name.split(' ')[1] || m.w1.Name}</span>
                                                                            </div>
                                                                            <div className="label-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{m.w1.Weight}lb</div>
                                                                        </div>
                                                                        <div className="flex-1 p-1 shape-small" style={{ backgroundColor: c2 + '20', borderLeft: `3px solid ${c2}` }}>
                                                                            <div className="flex items-center gap-1">
                                                                                <span className="label-small px-1 shape-extra-small" style={{ backgroundColor: c2, color: 'white' }}>{getAbbrev(m.w2.Team)}</span>
                                                                                <span className="label-small" style={{ color: c2 }}>{m.w2.Name.split(' ')[1] || m.w2.Name}</span>
                                                                            </div>
                                                                            <div className="label-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{m.w2.Weight}lb</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                        {ms.length === 0 && (
                                                            <div className="text-center py-8" style={{ color: 'var(--md-sys-color-outline)' }}>
                                                                <span className="material-icons-round" style={{ fontSize: 32 }}>inbox</span>
                                                                <p className="body-small mt-1">Drag matches here</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                    
                    {/* Dialogs */}
                    <Dialog isOpen={showSaveDialog} onClose={() => setShowSaveDialog(false)} title="Save Tournament">
                        <div className="m3-text-field mb-6">
                            <label>Tournament Name</label>
                            <input 
                                type="text" 
                                value={saveName} 
                                onChange={(e) => setSaveName(e.target.value)} 
                                autoFocus 
                                onKeyPress={(e) => e.key === 'Enter' && saveNew()}
                            />
                        </div>
                        <div className="flex gap-3 justify-end">
                            <button onClick={() => { setShowSaveDialog(false); setSaveName(''); }} className="m3-btn m3-btn-text">Cancel</button>
                            <button onClick={saveNew} className="m3-btn m3-btn-filled">Save</button>
                        </div>
                    </Dialog>
                    
                    <Dialog isOpen={showManageDialog} onClose={() => setShowManageDialog(false)} title="Manage Tournaments">
                        {savedTournaments.length === 0 ? (
                            <p className="body-large text-center py-8" style={{ color: 'var(--md-sys-color-outline)' }}>No saved tournaments yet.</p>
                        ) : (
                            <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar">
                                {savedTournaments.map(name => {
                                    const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                                    const lastMod = saved[name]?.lastModified ? new Date(saved[name].lastModified).toLocaleDateString() : 'Unknown';
                                    return (
                                        <div key={name} className="m3-card m3-card-outlined p-4 flex justify-between items-center">
                                            <div>
                                                <p className="title-medium">{name}</p>
                                                <p className="body-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>Last modified: {lastMod}</p>
                                            </div>
                                            <button 
                                                onClick={() => deleteTournament(name)} 
                                                className="m3-btn"
                                                style={{ backgroundColor: 'var(--md-sys-color-error-container)', color: 'var(--md-sys-color-on-error-container)' }}
                                            >
                                                <span className="material-icons-round" style={{ fontSize: 18 }}>delete</span>
                                                Delete
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </Dialog>
                    
                    <Dialog isOpen={showPasteDialog} onClose={() => setShowPasteDialog(false)} title="Paste Roster Data" size="lg">
                        <div className="space-y-4">
                            <div className="m3-text-field">
                                <label>Select Team</label>
                                <select value={pasteTeam} onChange={(e) => setPasteTeam(e.target.value)}>
                                    <option value="t1">{names.t1}</option>
                                    <option value="t2">{names.t2}</option>
                                    <option value="t3">{names.t3}</option>
                                </select>
                            </div>
                            <div className="m3-text-field">
                                <label>Paste Data (FirstName, LastName, Weight, DOB, Exp, Skill)</label>
                                <textarea 
                                    value={pasteText} 
                                    onChange={(e) => setPasteText(e.target.value)} 
                                    style={{ height: 200, fontFamily: 'monospace' }}
                                    placeholder="John,Doe,150,01/15/2010,2,3&#10;Jane,Smith,145,03/20/2011,1,2"
                                />
                            </div>
                            <div className="flex gap-3 justify-end">
                                <button onClick={() => { setShowPasteDialog(false); setPasteText(''); }} className="m3-btn m3-btn-text">Cancel</button>
                                <button onClick={handlePaste} className="m3-btn m3-btn-filled">Import</button>
                            </div>
                        </div>
                    </Dialog>
                    
                    <Dialog isOpen={showScratchDialog} onClose={() => setShowScratchDialog(false)} title="Scratched Wrestlers">
                        <p className="body-medium mb-4" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                            These wrestlers were removed from the tournament. Click "Restore" to add them back.
                        </p>
                        {scratched.length === 0 ? (
                            <p className="body-large text-center py-8" style={{ color: 'var(--md-sys-color-outline)' }}>No scratched wrestlers.</p>
                        ) : (
                            <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar">
                                {scratched.map((w, idx) => {
                                    const c = getColor(w.Team);
                                    return (
                                        <div key={idx} className="m3-card m3-card-outlined p-4 flex justify-between items-center" style={{ borderLeftWidth: 4, borderLeftColor: c }}>
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="label-medium px-2 py-1 shape-small" style={{ backgroundColor: c, color: 'white' }}>{getAbbrev(w.Team)}</span>
                                                    <span className="title-medium" style={{ color: c }}>{w.Name}</span>
                                                </div>
                                                <p className="body-small" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{w.Team}  {w.Weight} lbs  Age {w.Age}  Skill {w.Skill}</p>
                                            </div>
                                            <button onClick={() => restoreWrestler(w)} className="m3-btn" style={{ backgroundColor: 'var(--md-sys-color-success-container)', color: 'var(--md-sys-color-on-success-container)' }}>
                                                <span className="material-icons-round" style={{ fontSize: 18 }}>restore</span>
                                                Restore
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </Dialog>
                    
                    <Dialog isOpen={showAnalytics} onClose={() => setShowAnalytics(false)} title="Tournament Analytics" size="xl">
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <StatCard title="Total Wrestlers" value={analytics.totalWrestlers} icon="" color="primary" />
                                <StatCard title="Total Matches" value={analytics.totalMatches} icon="" color="secondary" />
                                <StatCard title="Avg Matches/Wrestler" value={analytics.avgMatchesPerWrestler} icon="" color="success" />
                                <StatCard title="Rest Violations" value={analytics.restViolations} icon="" color="warning" />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="m3-card m3-card-filled p-4">
                                    <h3 className="title-medium mb-4">Match Distribution</h3>
                                    <div className="space-y-3">
                                        {Object.entries(analytics.distribution).map(([count, wrestlers]) => (
                                            <div key={count} className="flex justify-between items-center gap-4">
                                                <span className="label-large" style={{ minWidth: 80 }}>{count} matches:</span>
                                                <div className="flex-1">
                                                    <div className="m3-progress">
                                                        <div className="m3-progress-bar" style={{ width: `${(wrestlers / analytics.totalWrestlers) * 100}%` }}></div>
                                                    </div>
                                                </div>
                                                <span className="title-small" style={{ minWidth: 32, textAlign: 'right' }}>{wrestlers}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="m3-card m3-card-filled p-4">
                                    <h3 className="title-medium mb-4">Mat Distribution</h3>
                                    <div className="space-y-3">
                                        {[1, 2, 3].map(mat => (
                                            <div key={mat} className="flex justify-between items-center gap-4">
                                                <span className="label-large" style={{ minWidth: 80 }}>Mat {mat}:</span>
                                                <div className="flex-1">
                                                    <div className="m3-progress" style={{ backgroundColor: 'var(--md-sys-color-tertiary-container)' }}>
                                                        <div className="m3-progress-bar" style={{ width: `${(analytics.matCounts[mat] / analytics.totalMatches) * 100}%`, backgroundColor: 'var(--md-sys-color-tertiary)' }}></div>
                                                    </div>
                                                </div>
                                                <span className="title-small" style={{ minWidth: 32, textAlign: 'right' }}>{analytics.matCounts[mat]}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="m3-card m3-card-filled p-4" style={{ backgroundColor: 'var(--md-sys-color-primary-container)' }}>
                                <h3 className="title-medium mb-4" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>Quality Score</h3>
                                <div className="flex items-center gap-6">
                                    <div className="display-medium" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>{analytics.avgQuality}</div>
                                    <div className="flex-1">
                                        <p className="body-small mb-2" style={{ color: 'var(--md-sys-color-on-primary-container)', opacity: 0.8 }}>Average match quality (out of 7)</p>
                                        <div className="m3-progress" style={{ height: 8 }}>
                                            <div className="m3-progress-bar" style={{ width: `${(analytics.avgQuality / 7) * 100}%` }}></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Dialog>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

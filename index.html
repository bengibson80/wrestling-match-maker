<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrestling Match Maker Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Fonts and Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    
    <style>
        /* Google Material 3 Design System - Blue Theme */
        :root {
            --md-sys-color-primary: #1a73e8;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #d3e3fd;
            --md-sys-color-on-primary-container: #041e49;
            
            --md-sys-color-secondary: #5f6368;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #e8eaed;
            --md-sys-color-on-secondary-container: #202124;
            
            --md-sys-color-tertiary: #1e8e3e;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #ceead6;
            --md-sys-color-on-tertiary-container: #0d652d;
            
            --md-sys-color-error: #d93025;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #fce8e6;
            --md-sys-color-on-error-container: #5f2120;
            
            --md-sys-color-warning: #f9ab00;
            --md-sys-color-on-warning: #202124;
            --md-sys-color-warning-container: #fef7e0;
            
            --md-sys-color-background: #ffffff;
            --md-sys-color-on-background: #202124;
            
            --md-sys-color-surface: #ffffff;
            --md-sys-color-on-surface: #202124;
            --md-sys-color-surface-variant: #f1f3f4;
            --md-sys-color-on-surface-variant: #5f6368;
            
            --md-sys-color-surface-container-lowest: #FFFFFF;
            --md-sys-color-surface-container-low: #f8f9fa;
            --md-sys-color-surface-container: #f1f3f4;
            --md-sys-color-surface-container-high: #e8eaed;
            --md-sys-color-surface-container-highest: #dadce0;
            
            --md-sys-color-outline: #80868b;
            --md-sys-color-outline-variant: #dadce0;
            
            /* Google Elevation */
            --md-sys-elevation-1: 0 1px 2px 0 rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
            --md-sys-elevation-2: 0 1px 2px 0 rgba(60, 64, 67, 0.3), 0 2px 6px 2px rgba(60, 64, 67, 0.15);
            --md-sys-elevation-3: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
            --md-sys-elevation-4: 0 2px 3px 0 rgba(60, 64, 67, 0.3), 0 6px 10px 4px rgba(60, 64, 67, 0.15);
            
            /* Google Shape */
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
        }
        
        * {
            font-family: 'Google Sans', 'Roboto', sans-serif;
        }
        
        body {
            font-size: 14px;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }
        
        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }
        
        .material-symbols-rounded.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        /* Google-style Button Styles */
        .md-filled-button {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 10px 24px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            border: none;
            cursor: pointer;
            box-shadow: none;
        }
        
        .md-filled-button:hover {
            background-color: #1557b0;
            box-shadow: var(--md-sys-elevation-1);
        }
        
        .md-filled-button:active {
            background-color: #174ea6;
        }
        
        .md-outlined-button {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 10px 24px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            cursor: pointer;
        }
        
        .md-outlined-button:hover {
            background-color: rgba(26, 115, 232, 0.04);
            border-color: var(--md-sys-color-primary);
        }
        
        .md-text-button {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: none;
            border-radius: var(--md-sys-shape-corner-large);
            padding: 10px 12px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            cursor: pointer;
        }
        
        .md-text-button:hover {
            background-color: rgba(26, 115, 232, 0.04);
        }
        
        /* Google-style Card Styles */
        .md-card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-medium);
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }
        
        .md-card:hover {
            box-shadow: var(--md-sys-elevation-1);
        }
        
        .md-card-elevated {
            background-color: var(--md-sys-color-surface);
            box-shadow: var(--md-sys-elevation-2);
            border-radius: var(--md-sys-shape-corner-medium);
        }
        
        .md-card-outlined {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
        }
        
        /* Google-style Input */
        .md-text-field {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-extra-small);
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            width: 100%;
        }
        
        .md-text-field:focus {
            outline: none;
            border: 2px solid var(--md-sys-color-primary);
        }
        
        /* Google-style Chips */
        .md-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: var(--md-sys-shape-corner-small);
            background-color: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Google FAB */
        .md-fab {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 16px;
            box-shadow: var(--md-sys-elevation-3);
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }
        
        .md-fab:hover {
            box-shadow: var(--md-sys-elevation-4);
        }
        
        /* Tab Styles */
        .tab-button {
            position: relative;
            padding: 12px 24px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s;
            border: none;
            background: transparent;
            cursor: pointer;
        }
        
        .tab-button.active {
            color: var(--md-sys-color-primary);
        }
        
        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--md-sys-color-primary);
            transform: scaleX(0);
            transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-button.active::after {
            transform: scaleX(1);
        }
        
        .tab-button:hover {
            background-color: rgba(26, 115, 232, 0.04);
        }
        
        /* Animations */
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @keyframes expandGap {
            from { padding-top: 0; padding-bottom: 0; }
            to { padding-top: 20px; padding-bottom: 20px; }
        }
        
        .animate-slide-in { animation: slideIn 0.3s cubic-bezier(0.2, 0, 0, 1); }
        .animate-fade-in { animation: fadeIn 0.3s cubic-bezier(0.2, 0, 0, 1); }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0, 0, 1); }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--md-sys-color-surface-variant); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--md-sys-color-on-surface-variant); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            animation: slideUp 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        
        /* Match Card */
        .match-card { 
            transition: all 0.2s ease;
        }
        .match-card:hover { transform: translateY(-2px); }
        .match-card.dragging { 
            opacity: 0.4; 
            transform: scale(0.98);
        }
        
        .wrestler-card { transition: all 0.2s ease; }
        .wrestler-card:hover { transform: translateX(4px); }
        
        /* Drag and Drop Indicators */
        .drop-indicator {
            height: 4px;
            background: var(--md-sys-color-primary);
            border-radius: 2px;
            margin: 4px 0;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            opacity: 0;
        }
        
        .drop-indicator.active {
            opacity: 1;
            height: 8px;
            background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            box-shadow: 0 0 12px rgba(26, 115, 232, 0.5);
        }
        
        .mat-column {
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        
        .mat-column.drag-over {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px var(--md-sys-color-primary), var(--md-sys-elevation-4);
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef, useMemo } = React;
        
        // Toast Component
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            const bgColor = type === 'success' ? 'var(--md-sys-color-tertiary-container)' : 
                           type === 'error' ? 'var(--md-sys-color-error-container)' : 
                           type === 'warning' ? 'var(--md-sys-color-warning-container)' :
                           'var(--md-sys-color-primary-container)';
            const textColor = type === 'success' ? 'var(--md-sys-color-on-tertiary-container)' : 
                             type === 'error' ? 'var(--md-sys-color-on-error-container)' : 
                             type === 'warning' ? 'var(--md-sys-color-on-warning)' :
                             'var(--md-sys-color-on-primary-container)';
            const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            
            return (
                <div className="toast md-card-elevated px-6 py-4 flex items-center gap-3" style={{ backgroundColor: bgColor, color: textColor }}>
                    <span className="material-symbols-rounded filled">{icon}</span>
                    <span className="font-medium">{message}</span>
                </div>
            );
        };
        
        // Modal Component
        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            const sizeClass = size === 'sm' ? 'max-w-md' : size === 'lg' ? 'max-w-4xl' : size === 'xl' ? 'max-w-6xl' : 'max-w-2xl';
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in" style={{ backgroundColor: 'rgba(0,0,0,0.32)' }} onClick={onClose}>
                    <div className={`md-card-elevated ${sizeClass} w-full max-h-[90vh] overflow-hidden animate-slide-up`} style={{ borderRadius: '28px' }} onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-5 flex justify-between items-center border-b" style={{ borderColor: 'var(--md-sys-color-outline-variant)' }}>
                            <h2 className="text-xl font-semibold" style={{ color: 'var(--md-sys-color-on-surface)' }}>{title}</h2>
                            <button onClick={onClose} className="md-text-button p-2">
                                <span className="material-symbols-rounded">close</span>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar" style={{ maxHeight: 'calc(90vh - 80px)' }}>
                            {children}
                        </div>
                    </div>
                </div>
            );
        };
        
        // Stat Card Component
        const StatCard = ({ title, value, icon, color }) => {
            const colors = {
                blue: 'var(--md-sys-color-primary)',
                purple: '#7c3aed',
                green: 'var(--md-sys-color-tertiary)',
                orange: 'var(--md-sys-color-warning)'
            };
            return (
                <div className="md-card p-6">
                    <div className="flex items-center justify-between mb-2">
                        <span className="material-symbols-rounded" style={{ fontSize: '36px', color: colors[color] || colors.blue }}>{icon}</span>
                        <div className="text-4xl font-bold" style={{ color: colors[color] || colors.blue }}>{value}</div>
                    </div>
                    <div className="text-sm font-medium" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{title}</div>
                </div>
            );
        };
        
        // Stats Badge Component for compact display
        const StatsBadges = ({ wtPct, ageDiff, expDiff, skillDiff, compact = false }) => {
            const size = compact ? 'text-xs px-1 py-0.5' : 'text-xs px-1.5 py-0.5';
            return (
                <div className="flex items-center gap-0.5">
                    <span className={`${size} rounded font-semibold ${wtPct <= 5 ? 'bg-green-100 text-green-800' : wtPct <= 8 ? 'bg-yellow-100 text-yellow-800' : 'bg-orange-100 text-orange-800'}`}>
                        W{wtPct.toFixed(0)}%
                    </span>
                    <span className={`${size} rounded font-semibold ${ageDiff === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        A{ageDiff}
                    </span>
                    <span className={`${size} rounded font-semibold ${expDiff <= 1 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        E{expDiff}
                    </span>
                    <span className={`${size} rounded font-semibold ${skillDiff === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        S{skillDiff}
                    </span>
                </div>
            );
        };
        
        // Stats Comparison Component - shows actual stats of both wrestlers with differences
        const StatsCompare = ({ w1, w2, compact = false }) => {
            const wtPct = ((Math.abs(w1.Weight - w2.Weight) / Math.min(w1.Weight, w2.Weight)) * 100);
            const ageDiff = Math.abs(w1.Age - w2.Age);
            const expDiff = Math.abs((w1.Exp || 1) - (w2.Exp || 1));
            const skillDiff = Math.abs(w1.Skill - w2.Skill);
            
            if (compact) {
                // Compact version for left column matchups - single line
                return (
                    <div className="flex items-center gap-1 text-xs flex-wrap">
                        <span className={`px-1 py-0.5 rounded font-semibold ${wtPct <= 5 ? 'bg-green-100 text-green-800' : wtPct <= 8 ? 'bg-yellow-100 text-yellow-800' : 'bg-orange-100 text-orange-800'}`}>
                            {w1.Weight}v{w2.Weight} ({wtPct.toFixed(0)}%)
                        </span>
                        <span className={`px-1 py-0.5 rounded font-semibold ${ageDiff === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                            A:{w1.Age}v{w2.Age}
                        </span>
                        <span className={`px-1 py-0.5 rounded font-semibold ${expDiff <= 1 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                            E:{w1.Exp || 1}v{w2.Exp || 1}
                        </span>
                        <span className={`px-1 py-0.5 rounded font-semibold ${skillDiff === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                            S:{w1.Skill}v{w2.Skill}
                        </span>
                    </div>
                );
            }
            
            // Full version for suggestions panel
            return (
                <div className="grid grid-cols-4 gap-1 text-xs">
                    <div className={`px-2 py-1 rounded text-center ${wtPct <= 5 ? 'bg-green-100 text-green-800' : wtPct <= 8 ? 'bg-yellow-100 text-yellow-800' : 'bg-orange-100 text-orange-800'}`}>
                        <div className="font-bold">{w1.Weight} vs {w2.Weight}</div>
                        <div className="opacity-75">Wt: {wtPct.toFixed(1)}%</div>
                    </div>
                    <div className={`px-2 py-1 rounded text-center ${ageDiff === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        <div className="font-bold">{w1.Age} vs {w2.Age}</div>
                        <div className="opacity-75">Age: ±{ageDiff}</div>
                    </div>
                    <div className={`px-2 py-1 rounded text-center ${expDiff <= 1 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        <div className="font-bold">{w1.Exp || 1} vs {w2.Exp || 1}</div>
                        <div className="opacity-75">Exp: ±{expDiff}</div>
                    </div>
                    <div className={`px-2 py-1 rounded text-center ${skillDiff === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                        <div className="font-bold">{w1.Skill} vs {w2.Skill}</div>
                        <div className="opacity-75">Skill: ±{skillDiff}</div>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            // State from Premium v2
            const [rosters, setRosters] = useState({ t1: [], t2: [], t3: [], t4: [] });
            const [names, setNames] = useState({ t1: 'Team 1', t2: 'Team 2', t3: 'Team 3', t4: 'Team 4' });
            const [abbrevs, setAbbrevs] = useState({ t1: 'T1', t2: 'T2', t3: 'T3', t4: 'T4' });
            const [colors, setColors] = useState({ t1: '#1a73e8', t2: '#7c3aed', t3: '#1e8e3e', t4: '#e8710a' });
            const [matches, setMatches] = useState([]);
            const [scratched, setScratched] = useState([]);
            const [settings, setSettings] = useState({ 
                maxWt: 10, 
                preferredWt: 5,
                maxAge: 1, 
                maxSkill: 2, 
                minMatchesPerWrestler: 2,
                maxPerMat: 25,
                minRestBetweenBouts: 4
            });
            const [tab, setTab] = useState('upload');
            const [teamView, setTeamView] = useState('t1');
            const [selected, setSelected] = useState(null);
            const [dragged, setDragged] = useState(null);
            const [draggedFromMat, setDraggedFromMat] = useState(null);
            const [dropTarget, setDropTarget] = useState({ mat: null, index: null });
            const [savedTournaments, setSavedTournaments] = useState([]);
            const [currentTournament, setCurrentTournament] = useState('');
            const [toast, setToast] = useState(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [filterText, setFilterText] = useState('');
            const [sortBy, setSortBy] = useState('name');
            
            // Modal states
            const [showSaveDialog, setShowSaveDialog] = useState(false);
            const [showManageDialog, setShowManageDialog] = useState(false);
            const [showPasteDialog, setShowPasteDialog] = useState(false);
            const [showScratchDialog, setShowScratchDialog] = useState(false);
            const [showNameDialog, setShowNameDialog] = useState(false);
            const [showManualDialog, setShowManualDialog] = useState(false);
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [showEditDialog, setShowEditDialog] = useState(false);
            const [showSearchOpponent, setShowSearchOpponent] = useState(false);
            const [pasteText, setPasteText] = useState('');
            
            const [pasteTeam, setPasteTeam] = useState('t1');
            const [saveName, setSaveName] = useState('');
            const [manualData, setManualData] = useState({ firstName: '', lastName: '', weight: '', dob: '', exp: '0', skill: '1', team: 't1' });
            const [editData, setEditData] = useState(null);
            const [opponentSearch, setOpponentSearch] = useState('');
            
            const total = rosters.t1.length + rosters.t2.length + rosters.t3.length + rosters.t4.length;
            
            const showToast = useCallback((message, type = 'info') => {
                setToast({ message, type });
            }, []);
            
            // Load saved tournaments
            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                setSavedTournaments(Object.keys(saved));
            }, []);
            
            // Auto-save
            useEffect(() => {
                if (currentTournament) {
                    const state = { rosters, names, abbrevs, colors, matches, scratched, settings };
                    const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                    saved[currentTournament] = { ...state, lastModified: new Date().toISOString() };
                    localStorage.setItem('wrestlingTournaments', JSON.stringify(saved));
                }
            }, [rosters, names, abbrevs, colors, matches, scratched, settings, currentTournament]);
            
            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 's') { e.preventDefault(); setShowSaveDialog(true); }
                        else if (e.key === 'z') { e.preventDefault(); undo(); }
                        else if (e.key === 'y') { e.preventDefault(); redo(); }
                    }
                };
                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [historyIndex]);
            
            const addToHistory = useCallback((state) => {
                setHistory(prev => [...prev.slice(0, historyIndex + 1), state]);
                setHistoryIndex(prev => prev + 1);
            }, [historyIndex]);
            
            const undo = () => {
                if (historyIndex > 0) {
                    setMatches(history[historyIndex - 1].matches);
                    setHistoryIndex(prev => prev - 1);
                    showToast('Undo successful', 'info');
                }
            };
            
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    setMatches(history[historyIndex + 1].matches);
                    setHistoryIndex(prev => prev + 1);
                    showToast('Redo successful', 'info');
                }
            };
            
            const saveNew = () => {
                if (!saveName.trim()) { showToast('Please enter a tournament name', 'error'); return; }
                const state = { rosters, names, abbrevs, colors, matches, scratched, settings };
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                saved[saveName] = { ...state, lastModified: new Date().toISOString() };
                localStorage.setItem('wrestlingTournaments', JSON.stringify(saved));
                setSavedTournaments(Object.keys(saved));
                setCurrentTournament(saveName);
                setSaveName('');
                setShowSaveDialog(false);
                showToast(`Tournament "${saveName}" saved!`, 'success');
            };
            
            const loadTournament = (name) => {
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                if (saved[name]) {
                    const data = saved[name];
                    setRosters(data.rosters);
                    setNames(data.names);
                    setAbbrevs(data.abbrevs || { t1: 'T1', t2: 'T2', t3: 'T3', t4: 'T4' });
                    setColors(data.colors);
                    setMatches(data.matches);
                    setScratched(data.scratched || []);
                    setSettings(data.settings);
                    setCurrentTournament(name);
                    showToast(`Loaded "${name}"`, 'success');
                }
            };
            
            const deleteTournament = (name) => {
                const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                delete saved[name];
                localStorage.setItem('wrestlingTournaments', JSON.stringify(saved));
                setSavedTournaments(Object.keys(saved));
                if (currentTournament === name) setCurrentTournament('');
                showToast(`Deleted "${name}"`, 'info');
            };
            
            const newTournament = () => {
                setRosters({ t1: [], t2: [], t3: [], t4: [] });
                setNames({ t1: 'Team 1', t2: 'Team 2', t3: 'Team 3', t4: 'Team 4' });
                setAbbrevs({ t1: 'T1', t2: 'T2', t3: 'T3', t4: 'T4' });
                setColors({ t1: '#1a73e8', t2: '#7c3aed', t3: '#1e8e3e', t4: '#e8710a' });
                setMatches([]);
                setScratched([]);
                setCurrentTournament('');
                setTab('upload');
                showToast('New tournament created', 'success');
            };
            
            const renumber = (ms) => {
                const byMat = { 1: [], 2: [], 3: [] };
                ms.forEach(m => byMat[m.mat].push(m));
                const result = [];
                [1, 2, 3].forEach(mat => {
                    byMat[mat].sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((m, i) => {
                        result.push({ ...m, num: mat * 100 + i, order: i });
                    });
                });
                return result;
            };
            
            const calcAge = (dob) => {
                // Parse date components to avoid timezone issues
                let year, month, day;
                
                if (typeof dob === 'string') {
                    if (dob.includes('/')) {
                        // MM/DD/YYYY or M/D/YYYY format
                        const parts = dob.split('/');
                        month = parseInt(parts[0]);
                        day = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                    } else if (dob.includes('-')) {
                        // YYYY-MM-DD format (ISO)
                        const parts = dob.split('-');
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]);
                        day = parseInt(parts[2]);
                    } else {
                        // Fallback - try to parse and extract components
                        const d = new Date(dob);
                        year = d.getFullYear();
                        month = d.getMonth() + 1;
                        day = d.getDate();
                    }
                } else if (dob instanceof Date) {
                    year = dob.getFullYear();
                    month = dob.getMonth() + 1;
                    day = dob.getDate();
                } else {
                    // Fallback
                    const d = new Date(dob);
                    year = d.getFullYear();
                    month = d.getMonth() + 1;
                    day = d.getDate();
                }
                
                const today = new Date();
                const todayYear = today.getFullYear();
                const todayMonth = today.getMonth() + 1;
                const todayDay = today.getDate();
                
                let age = todayYear - year;
                if (todayMonth < month || (todayMonth === month && todayDay < day)) {
                    age--;
                }
                return age;
            };
            
            const parseData = (text) => {
                const errors = [], warnings = [], validRows = [];
                const lines = text.trim().split('\n');
                
                lines.forEach((line, index) => {
                    if (!line.trim()) return;
                    const v = line.split(/[,\t]/).map(x => x.trim());
                    
                    // Skip header row (only first row)
                    if (index === 0) {
                        const headerKeywords = ['first', 'name', 'last', 'weight', 'dob', 'birth', 'age', 'exp', 'experience', 'skill'];
                        if (headerKeywords.some(k => v[0]?.toLowerCase()?.includes(k))) return;
                    }
                    
                    // Check column count
                    if (v.length < 6) { 
                        errors.push(`Row ${index + 1}: Not enough columns (need 6, found ${v.length})`); 
                        return; 
                    }
                    
                    const [firstName, lastName, weight, dob, exp, skill] = v;
                    
                    // Check for blank required fields
                    if (!firstName || firstName.trim() === '') { 
                        errors.push(`Row ${index + 1}: First name is blank`); 
                        return; 
                    }
                    if (!lastName || lastName.trim() === '') { 
                        errors.push(`Row ${index + 1}: Last name is blank`); 
                        return; 
                    }
                    if (!weight || weight.trim() === '') { 
                        errors.push(`Row ${index + 1}: Weight is blank`); 
                        return; 
                    }
                    if (!dob || dob.trim() === '') { 
                        errors.push(`Row ${index + 1}: DOB is blank`); 
                        return; 
                    }
                    if (exp === undefined || exp === null || exp.toString().trim() === '') { 
                        errors.push(`Row ${index + 1}: Experience is blank`); 
                        return; 
                    }
                    if (skill === undefined || skill === null || skill.toString().trim() === '') { 
                        errors.push(`Row ${index + 1}: Skill is blank`); 
                        return; 
                    }
                    
                    // Validate weight
                    const weightVal = parseFloat(weight);
                    if (isNaN(weightVal) || weightVal <= 0) { 
                        errors.push(`Row ${index + 1}: Invalid weight "${weight}"`); 
                        return; 
                    }
                    
                    // Validate DOB
                    const dobDate = new Date(dob);
                    if (isNaN(dobDate.getTime())) { 
                        errors.push(`Row ${index + 1}: Invalid date "${dob}"`); 
                        return; 
                    }
                    
                    // Validate experience (0-6)
                    const expVal = parseInt(exp);
                    if (isNaN(expVal) || expVal < 0 || expVal > 6) { 
                        errors.push(`Row ${index + 1}: Experience must be 0-6, got "${exp}"`); 
                        return; 
                    }
                    
                    // Validate skill (1-5, 0 is not allowed)
                    const skillVal = parseInt(skill);
                    if (isNaN(skillVal) || skillVal < 1 || skillVal > 5) { 
                        errors.push(`Row ${index + 1}: Skill must be 1-5, got "${skill}"`); 
                        return; 
                    }
                    
                    const age = calcAge(dob);
                    validRows.push({ FirstName: firstName, LastName: lastName, Weight: weightVal, DOB: dob, Exp: expVal, Skill: skillVal, Age: age, Name: `${firstName} ${lastName}` });
                });
                
                return { data: validRows, errors, warnings };
            };
            
            const loadFile = (team, e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const processResult = (result) => {
                    if (result.errors.length > 0) {
                        // Reject upload and show errors
                        const errorMsg = result.errors.length <= 3 
                            ? result.errors.join('\n') 
                            : `${result.errors.slice(0, 3).join('\n')}\n...and ${result.errors.length - 3} more errors`;
                        alert(`Upload rejected due to formatting errors:\n\n${errorMsg}\n\nPlease fix and try again.`);
                        return;
                    }
                    if (result.data.length > 0) {
                        const wrestlers = result.data.map(w => ({ ...w, Team: names[team] }));
                        setRosters(prev => ({ ...prev, [team]: [...prev[team], ...wrestlers] }));
                        showToast(`Loaded ${wrestlers.length} wrestlers`, 'success');
                    } else {
                        showToast('No valid data found in file', 'error');
                    }
                };
                
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = new Uint8Array(ev.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const json = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, dateNF: 'mm/dd/yyyy' });
                            const csvLines = json.map(row => row.filter((_, i) => row.slice(0, i + 1).some(c => c)).join(',')).join('\n');
                            
                            const result = parseData(csvLines);
                            processResult(result);
                        } catch (err) {
                            showToast('Error reading file: ' + err.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const result = parseData(ev.target.result);
                        processResult(result);
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            };
            
            const handlePaste = () => {
                const result = parseData(pasteText);
                if (result.errors.length > 0) {
                    // Show errors and don't close dialog
                    const errorMsg = result.errors.length <= 5 
                        ? result.errors.join('\n') 
                        : `${result.errors.slice(0, 5).join('\n')}\n...and ${result.errors.length - 5} more errors`;
                    alert(`Data rejected due to formatting errors:\n\n${errorMsg}\n\nPlease fix and try again.`);
                    return;
                }
                if (result.data.length > 0) {
                    const wrestlers = result.data.map(w => ({ ...w, Team: names[pasteTeam] }));
                    setRosters(prev => ({ ...prev, [pasteTeam]: [...prev[pasteTeam], ...wrestlers] }));
                    showToast(`Added ${wrestlers.length} wrestlers`, 'success');
                    setShowPasteDialog(false);
                    setPasteText('');
                } else {
                    showToast('No valid data found', 'error');
                }
            };
            
            const handleManualAdd = () => {
                if (!manualData.firstName || !manualData.lastName || !manualData.weight || !manualData.dob) {
                    showToast('Please fill all required fields', 'error');
                    return;
                }
                
                const wrestler = {
                    FirstName: manualData.firstName,
                    LastName: manualData.lastName,
                    Name: `${manualData.firstName} ${manualData.lastName}`,
                    Team: names[manualData.team],
                    Weight: parseFloat(manualData.weight),
                    Age: calcAge(manualData.dob),
                    DOB: manualData.dob,
                    Exp: parseInt(manualData.exp),
                    Skill: parseInt(manualData.skill)
                };
                
                setRosters(prev => ({ ...prev, [manualData.team]: [...prev[manualData.team], wrestler] }));
                setManualData({ firstName: '', lastName: '', weight: '', dob: '', exp: '0', skill: '1', team: 't1' });
                setShowManualDialog(false);
                showToast('Wrestler added successfully!', 'success');
            };
            
            // Edit wrestler function
            const openEditDialog = (wrestler, teamKey) => {
                // Convert DOB to YYYY-MM-DD format for date input
                let dobFormatted = wrestler.DOB;
                if (wrestler.DOB && wrestler.DOB.includes('/')) {
                    const parts = wrestler.DOB.split('/');
                    dobFormatted = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                }
                
                setEditData({
                    original: wrestler,
                    teamKey: teamKey,
                    firstName: wrestler.FirstName || wrestler.Name.split(' ')[0],
                    lastName: wrestler.LastName || wrestler.Name.split(' ').slice(1).join(' '),
                    weight: wrestler.Weight.toString(),
                    dob: dobFormatted,
                    exp: wrestler.Exp?.toString() || '0',
                    skill: wrestler.Skill?.toString() || '1'
                });
                setShowEditDialog(true);
            };
            
            const handleEditSave = () => {
                if (!editData) return;
                
                if (!editData.firstName || !editData.lastName || !editData.weight || !editData.dob) {
                    showToast('Please fill all required fields', 'error');
                    return;
                }
                
                const updatedWrestler = {
                    ...editData.original,
                    FirstName: editData.firstName,
                    LastName: editData.lastName,
                    Name: `${editData.firstName} ${editData.lastName}`,
                    Weight: parseFloat(editData.weight),
                    Age: calcAge(editData.dob),
                    DOB: editData.dob,
                    Exp: parseInt(editData.exp),
                    Skill: parseInt(editData.skill)
                };
                
                // Update in roster
                setRosters(prev => ({
                    ...prev,
                    [editData.teamKey]: prev[editData.teamKey].map(w => 
                        w.Name === editData.original.Name ? updatedWrestler : w
                    )
                }));
                
                // Update in matches
                setMatches(prev => prev.map(m => ({
                    ...m,
                    w1: (m.w1.Name === editData.original.Name && m.w1.Team === editData.original.Team) ? updatedWrestler : m.w1,
                    w2: (m.w2.Name === editData.original.Name && m.w2.Team === editData.original.Team) ? updatedWrestler : m.w2
                })));
                
                // Update selected if it's the same wrestler
                if (selected?.Name === editData.original.Name && selected?.Team === editData.original.Team) {
                    setSelected(updatedWrestler);
                }
                
                setShowEditDialog(false);
                setEditData(null);
                showToast('Wrestler updated successfully!', 'success');
            };
            
            const scratchWrestler = (wrestler) => {
                const team = Object.keys(names).find(k => names[k] === wrestler.Team);
                setRosters(prev => ({ ...prev, [team]: prev[team].filter(w => w.Name !== wrestler.Name) }));
                const updatedMatches = matches.filter(m => 
                    !(m.w1.Name === wrestler.Name && m.w1.Team === wrestler.Team) &&
                    !(m.w2.Name === wrestler.Name && m.w2.Team === wrestler.Team)
                );
                setMatches(renumber(updatedMatches));
                setScratched(prev => [...prev, wrestler]);
                if (selected?.Name === wrestler.Name) setSelected(null);
                showToast(`${wrestler.Name} scratched`, 'warning');
            };
            
            const restoreWrestler = (wrestler) => {
                const team = Object.keys(names).find(k => names[k] === wrestler.Team);
                setRosters(prev => ({ ...prev, [team]: [...prev[team], wrestler] }));
                setScratched(prev => prev.filter(w => !(w.Name === wrestler.Name && w.Team === wrestler.Team)));
                showToast(`${wrestler.Name} restored`, 'success');
            };
            
            const deleteWrestler = (wrestler, teamKey) => {
                if (confirm(`Delete ${wrestler.Name} permanently?`)) {
                    setRosters(prev => ({ ...prev, [teamKey]: prev[teamKey].filter(w => w.Name !== wrestler.Name) }));
                    showToast(`${wrestler.Name} deleted`, 'info');
                }
            };
            
            const handleTeamNameChange = (teamKey, newName) => {
                const oldName = names[teamKey];
                setNames(p => ({ ...p, [teamKey]: newName }));
                setRosters(prev => ({ ...prev, [teamKey]: prev[teamKey].map(w => ({ ...w, Team: newName })) }));
                setMatches(prev => prev.map(m => ({
                    ...m,
                    w1: m.w1.Team === oldName ? { ...m.w1, Team: newName } : m.w1,
                    w2: m.w2.Team === oldName ? { ...m.w2, Team: newName } : m.w2
                })));
                setScratched(prev => prev.map(w => w.Team === oldName ? { ...w, Team: newName } : w));
            };
            
            // Updated calcScore to include expDiff - now supports forceCalc for manual search
            const calcScore = (w1, w2, expanded = false, forceCalc = false) => {
                const wtDiff = Math.abs(w1.Weight - w2.Weight);
                const wtPct = (wtDiff / Math.min(w1.Weight, w2.Weight)) * 100;
                const ageDiff = Math.abs(w1.Age - w2.Age);
                const skillDiff = Math.abs(w1.Skill - w2.Skill);
                const expDiff = Math.abs((w1.Exp || 1) - (w2.Exp || 1));
                
                // Use expanded limits (2x normal) for wrestlers with no matches
                const maxWtLimit = expanded ? settings.maxWt * 2 : settings.maxWt;
                const maxAgeLimit = expanded ? settings.maxAge * 2 : settings.maxAge;
                const maxSkillLimit = expanded ? settings.maxSkill * 2 : settings.maxSkill;
                
                // For forceCalc, always return data but mark if outside criteria
                if (forceCalc) {
                    const withinCriteria = wtPct <= settings.maxWt && ageDiff <= settings.maxAge && skillDiff <= settings.maxSkill && w1.Team !== w2.Team;
                    const withinExpanded = wtPct <= maxWtLimit && ageDiff <= maxAgeLimit && skillDiff <= maxSkillLimit && w1.Team !== w2.Team;
                    const wtScore = wtPct <= settings.preferredWt ? wtPct * 2 : wtPct * 3;
                    return { 
                        score: wtScore + skillDiff * 1.5 + ageDiff * 0.5, 
                        wtPct, wtDiff, ageDiff, skillDiff, expDiff, 
                        expanded: !withinCriteria && withinExpanded,
                        outsideCriteria: !withinCriteria && !withinExpanded,
                        sameTeam: w1.Team === w2.Team
                    };
                }
                
                if (wtPct > maxWtLimit || ageDiff > maxAgeLimit || skillDiff > maxSkillLimit || w1.Team === w2.Team) return null;
                
                const wtScore = wtPct <= settings.preferredWt ? wtPct * 2 : wtPct * 3;
                return { score: wtScore + skillDiff * 1.5 + ageDiff * 0.5, wtPct, wtDiff, ageDiff, skillDiff, expDiff, expanded };
            };
            
            const generate = () => {
                const all = [...rosters.t1, ...rosters.t2, ...rosters.t3, ...rosters.t4];
                const counts = {};
                all.forEach(w => counts[`${w.Name}-${w.Team}`] = 0);
                
                const possible = [];
                for (let i = 0; i < all.length; i++) {
                    for (let j = i + 1; j < all.length; j++) {
                        const q = calcScore(all[i], all[j]);
                        if (q) {
                            possible.push({ 
                                w1: all[i], w2: all[j], 
                                w1Key: `${all[i].Name}-${all[i].Team}`, 
                                w2Key: `${all[j].Name}-${all[j].Team}`,
                                avgSkill: (all[i].Skill + all[j].Skill) / 2,
                                ...q 
                            });
                        }
                    }
                }
                possible.sort((a, b) => a.score - b.score);
                
                const assignMat = (match, matCounts) => {
                    const skill = match.avgSkill;
                    if (skill <= 1) {
                        if (matCounts[1] < settings.maxPerMat) return 1;
                        if (matCounts[2] < settings.maxPerMat) return 2;
                        if (matCounts[3] < settings.maxPerMat) return 3;
                    }
                    if (skill <= 3) {
                        if (matCounts[2] < settings.maxPerMat) return 2;
                        if (matCounts[3] < settings.maxPerMat) return 3;
                        if (matCounts[1] < settings.maxPerMat) return 1;
                    }
                    if (matCounts[3] < settings.maxPerMat) return 3;
                    if (matCounts[2] < settings.maxPerMat) return 2;
                    if (matCounts[1] < settings.maxPerMat) return 1;
                    return null;
                };
                
                const result = [];
                const matCounts = { 1: 0, 2: 0, 3: 0 };
                
                // First pass: ensure everyone gets at least one match
                for (const m of possible) {
                    if (counts[m.w1Key] >= 3 || counts[m.w2Key] >= 3) continue;
                    if (counts[m.w1Key] === 0 || counts[m.w2Key] === 0) {
                        const mat = assignMat(m, matCounts);
                        if (mat) {
                            result.push({ ...m, mat, num: mat * 100 + matCounts[mat], order: matCounts[mat] });
                            matCounts[mat]++;
                            counts[m.w1Key]++;
                            counts[m.w2Key]++;
                        }
                    }
                }
                
                // Second pass: fill up to minimum matches
                let iterations = 0;
                while (iterations++ < possible.length * 2) {
                    const minMatches = Math.min(...Object.values(counts));
                    if (minMatches >= settings.minMatchesPerWrestler) break;
                    
                    let added = false;
                    for (const m of possible) {
                        if (counts[m.w1Key] >= 3 || counts[m.w2Key] >= 3) continue;
                        if (counts[m.w1Key] < settings.minMatchesPerWrestler || counts[m.w2Key] < settings.minMatchesPerWrestler) {
                            const mat = assignMat(m, matCounts);
                            if (mat) {
                                result.push({ ...m, mat, num: mat * 100 + matCounts[mat], order: matCounts[mat] });
                                matCounts[mat]++;
                                counts[m.w1Key]++;
                                counts[m.w2Key]++;
                                added = true;
                                break;
                            }
                        }
                    }
                    if (!added) break;
                }
                
                setMatches(result);
                addToHistory({ matches: result });
                setTab('mats');
                showToast(`Generated ${result.length} matches!`, 'success');
            };
            
            const getMatches = (w) => matches.filter(m => (m.w1.Name === w.Name && m.w1.Team === w.Team) || (m.w2.Name === w.Name && m.w2.Team === w.Team));
            
            const delMatch = (num) => {
                const newMatches = renumber(matches.filter(m => m.num !== num));
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
                showToast('Match deleted', 'info');
            };
            
            const addMatch = (w, opp) => {
                let q = calcScore(w, opp);
                if (!q) {
                    // Try with expanded criteria
                    q = calcScore(w, opp, true);
                }
                if (!q) {
                    // Force calculate for manual additions outside all criteria
                    q = calcScore(w, opp, true, true);
                }
                if (!q || q.sameTeam) {
                    showToast('Cannot create match between wrestlers on the same team', 'error');
                    return;
                }
                const mat = 1;
                const newMatches = renumber([...matches, { w1: w, w2: opp, w1Key: `${w.Name}-${w.Team}`, w2Key: `${opp.Name}-${opp.Team}`, mat, order: matches.filter(m => m.mat === mat).length, ...q }]);
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
                setSelected(null);
                setShowSearchOpponent(false);
                setOpponentSearch('');
                showToast('Match added', 'success');
            };
            
            // Updated moveMat to support inline placement
            const moveMatchToPosition = (matchNum, targetMat, targetIndex) => {
                const match = matches.find(m => m.num === matchNum);
                if (!match) return;
                
                // Remove match from current position
                let newMatches = matches.filter(m => m.num !== matchNum);
                
                // Get matches for target mat and insert at position
                const targetMatMatches = newMatches.filter(m => m.mat === targetMat).sort((a, b) => a.order - b.order);
                const otherMatches = newMatches.filter(m => m.mat !== targetMat);
                
                // Insert the match at the target index
                const updatedMatch = { ...match, mat: targetMat };
                targetMatMatches.splice(targetIndex, 0, updatedMatch);
                
                // Update order for all matches in target mat
                targetMatMatches.forEach((m, i) => m.order = i);
                
                newMatches = renumber([...otherMatches, ...targetMatMatches]);
                setMatches(newMatches);
                addToHistory({ matches: newMatches });
                showToast(`Match moved to Mat ${targetMat} position ${targetIndex + 1}`, 'success');
            };
            
            // Improved getSuggestions - prioritizes wrestlers with fewer matches
            const getSuggestions = (w) => {
                const all = [...rosters.t1, ...rosters.t2, ...rosters.t3, ...rosters.t4];
                const current = getMatches(w);
                const matched = new Set(current.map(m => m.w1.Name === w.Name ? `${m.w2.Name}-${m.w2.Team}` : `${m.w1.Name}-${m.w1.Team}`));
                const hasNoMatches = current.length === 0;
                
                // Get all potential opponents (different team, not already matched)
                const potentialOpponents = all.filter(x => 
                    x.Name !== w.Name && 
                    x.Team !== w.Team && 
                    !matched.has(`${x.Name}-${x.Team}`)
                );
                
                // Calculate scores for all potential opponents - try normal then expanded
                let suggestions = potentialOpponents
                    .map(x => {
                        const score = calcScore(w, x, false);
                        if (score) {
                            // Match is within normal criteria - explicitly mark as not expanded
                            return { w: x, ...score, expanded: false, matchCount: getMatches(x).length };
                        }
                        const expandedScore = calcScore(w, x, true);
                        if (expandedScore) {
                            // Match only valid with expanded criteria - mark as expanded
                            return { w: x, ...expandedScore, expanded: true, matchCount: getMatches(x).length };
                        }
                        return null;
                    })
                    .filter(x => x !== null)
                    .sort((a, b) => {
                        // Prioritize wrestlers with fewer matches first
                        if (a.matchCount !== b.matchCount) {
                            return a.matchCount - b.matchCount;
                        }
                        // Then by score
                        return a.score - b.score;
                    })
                    .slice(0, 15); // Show more suggestions
                
                return suggestions;
            };
            
            // Search all wrestlers from other teams for manual matchup
            const searchAllOpponents = (w, searchTerm) => {
                const all = [...rosters.t1, ...rosters.t2, ...rosters.t3, ...rosters.t4];
                const current = getMatches(w);
                const matched = new Set(current.map(m => m.w1.Name === w.Name ? `${m.w2.Name}-${m.w2.Team}` : `${m.w1.Name}-${m.w1.Team}`));
                
                const searchLower = searchTerm.toLowerCase();
                
                return all
                    .filter(x => 
                        x.Name !== w.Name && 
                        x.Team !== w.Team && 
                        !matched.has(`${x.Name}-${x.Team}`) &&
                        (x.Name.toLowerCase().includes(searchLower) || 
                         x.Weight.toString().includes(searchTerm) ||
                         (x.FirstName && x.FirstName.toLowerCase().includes(searchLower)) ||
                         (x.LastName && x.LastName.toLowerCase().includes(searchLower)))
                    )
                    .map(x => {
                        const scoreData = calcScore(w, x, false, true);
                        return { w: x, ...scoreData, matchCount: getMatches(x).length };
                    })
                    .sort((a, b) => a.score - b.score)
                    .slice(0, 20);
            };
            
            const getColor = (team) => {
                const k = Object.keys(names).find(x => names[x] === team);
                return k ? colors[k] : '#5f6368';
            };
            
            const getAbbrev = (team) => {
                const k = Object.keys(names).find(x => names[x] === team);
                return k ? abbrevs[k] : 'XX';
            };
            
            const needsRestHighlight = (wrestler, matchNum, mat) => {
                const wrestlerMatches = matches
                    .filter(m => m.mat === mat)
                    .filter(m => (m.w1.Name === wrestler.Name && m.w1.Team === wrestler.Team) || (m.w2.Name === wrestler.Name && m.w2.Team === wrestler.Team))
                    .sort((a, b) => a.order - b.order);
                
                if (wrestlerMatches.length < 2) return false;
                
                for (let i = 0; i < wrestlerMatches.length - 1; i++) {
                    const gap = wrestlerMatches[i + 1].order - wrestlerMatches[i].order;
                    if (gap <= settings.minRestBetweenBouts) {
                        if (wrestlerMatches[i].num === matchNum || wrestlerMatches[i + 1].num === matchNum) return true;
                    }
                }
                return false;
            };
            
            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                
                ['t1', 't2', 't3', 't4'].forEach(tk => {
                    if (!rosters[tk].length) return;
                    const data = [['Age', 'Weight', 'Skill', '', `${names[tk]} (${abbrevs[tk]})`]];
                    rosters[tk].sort((a, b) => (a.LastName || a.Name).localeCompare(b.LastName || b.Name)).forEach(w => {
                        const ms = getMatches(w).sort((a, b) => a.num - b.num);
                        const row = [w.Age, w.Weight, w.Skill, '', `${w.LastName || w.Name.split(' ')[1]}, ${w.FirstName || w.Name.split(' ')[0]}`];
                        ms.forEach(m => {
                            const opp = m.w1.Name === w.Name ? m.w2 : m.w1;
                            const oppTeamKey = Object.keys(names).find(k => names[k] === opp.Team);
                            const oppAbbrev = oppTeamKey ? abbrevs[oppTeamKey] : 'XX';
                            row.push(m.num, `${oppAbbrev}-${opp.FirstName?.charAt(0) || opp.Name.charAt(0)} ${opp.LastName || opp.Name.split(' ')[1] || ''}`);
                        });
                        data.push(row);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{ wch: 5 }, { wch: 8 }, { wch: 5 }, { wch: 2 }, { wch: 25 }, { wch: 8 }, { wch: 18 }];
                    XLSX.utils.book_append_sheet(wb, ws, names[tk].substring(0, 31));
                });
                
                [1, 2, 3].forEach(mat => {
                    const ms = matches.filter(m => m.mat === mat).sort((a, b) => a.order - b.order);
                    if (!ms.length) return;
                    const data = [['#', 'Team 1', 'Wrestler 1', 'Wt', 'vs', 'Team 2', 'Wrestler 2', 'Wt', 'Wt%', 'Winner']];
                    ms.forEach(m => {
                        data.push([m.num, abbrevs[Object.keys(names).find(k => names[k] === m.w1.Team)] || 'XX', 
                            `${m.w1.LastName || m.w1.Name}, ${m.w1.FirstName || ''}`, m.w1.Weight, 'vs',
                            abbrevs[Object.keys(names).find(k => names[k] === m.w2.Team)] || 'XX',
                            `${m.w2.LastName || m.w2.Name}, ${m.w2.FirstName || ''}`, m.w2.Weight, `${m.wtPct.toFixed(1)}%`, '']);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{ wch: 5 }, { wch: 6 }, { wch: 20 }, { wch: 5 }, { wch: 3 }, { wch: 6 }, { wch: 20 }, { wch: 5 }, { wch: 6 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, ws, `Mat ${mat}`);
                });
                
                XLSX.writeFile(wb, 'wrestling_matches.xlsx');
                showToast('Exported to Excel', 'success');
            };
            
            const getFilteredRoster = (tk) => {
                let filtered = rosters[tk].filter(w => 
                    w.Name.toLowerCase().includes(filterText.toLowerCase()) ||
                    w.Weight.toString().includes(filterText)
                );
                
                switch (sortBy) {
                    case 'weight': filtered.sort((a, b) => a.Weight - b.Weight); break;
                    case 'skill': filtered.sort((a, b) => b.Skill - a.Skill); break;
                    case 'matches': filtered.sort((a, b) => getMatches(b).length - getMatches(a).length); break;
                    default: filtered.sort((a, b) => (a.LastName || a.Name).localeCompare(b.LastName || b.Name));
                }
                return filtered;
            };
            
            const analytics = useMemo(() => {
                const allWrestlers = [...rosters.t1, ...rosters.t2, ...rosters.t3, ...rosters.t4];
                const matchCounts = {};
                matches.forEach(m => {
                    matchCounts[m.w1.Name] = (matchCounts[m.w1.Name] || 0) + 1;
                    matchCounts[m.w2.Name] = (matchCounts[m.w2.Name] || 0) + 1;
                });
                
                const distribution = {};
                Object.values(matchCounts).forEach(count => {
                    distribution[count] = (distribution[count] || 0) + 1;
                });
                
                const avgMatches = allWrestlers.length > 0 ? 
                    (Object.values(matchCounts).reduce((a, b) => a + b, 0) / allWrestlers.length).toFixed(1) : 0;
                
                const avgQuality = matches.length > 0 ?
                    (matches.reduce((sum, m) => sum + (7 - m.score), 0) / matches.length).toFixed(1) : 0;
                
                // Calculate rest violations
                let restViolations = 0;
                const countedViolations = new Set(); // Track unique violations to avoid double counting
                
                [1, 2, 3].forEach(mat => {
                    const matMatches = matches.filter(m => m.mat === mat).sort((a, b) => a.order - b.order);
                    
                    // Check each wrestler's matches on this mat
                    const wrestlerMatchesOnMat = {};
                    matMatches.forEach(m => {
                        const w1Key = `${m.w1.Name}-${m.w1.Team}`;
                        const w2Key = `${m.w2.Name}-${m.w2.Team}`;
                        if (!wrestlerMatchesOnMat[w1Key]) wrestlerMatchesOnMat[w1Key] = [];
                        if (!wrestlerMatchesOnMat[w2Key]) wrestlerMatchesOnMat[w2Key] = [];
                        wrestlerMatchesOnMat[w1Key].push(m);
                        wrestlerMatchesOnMat[w2Key].push(m);
                    });
                    
                    // Check for violations
                    Object.values(wrestlerMatchesOnMat).forEach(wrestlerMatches => {
                        if (wrestlerMatches.length < 2) return;
                        wrestlerMatches.sort((a, b) => a.order - b.order);
                        for (let i = 0; i < wrestlerMatches.length - 1; i++) {
                            const gap = wrestlerMatches[i + 1].order - wrestlerMatches[i].order;
                            if (gap <= settings.minRestBetweenBouts) {
                                // Create unique key for this violation pair
                                const violationKey = `${wrestlerMatches[i].num}-${wrestlerMatches[i + 1].num}`;
                                if (!countedViolations.has(violationKey)) {
                                    countedViolations.add(violationKey);
                                    restViolations++;
                                }
                            }
                        }
                    });
                });
                
                return {
                    totalWrestlers: allWrestlers.length,
                    totalMatches: matches.length,
                    avgMatchesPerWrestler: avgMatches,
                    distribution,
                    avgQuality,
                    matCounts: { 1: matches.filter(m => m.mat === 1).length, 2: matches.filter(m => m.mat === 2).length, 3: matches.filter(m => m.mat === 3).length },
                    restViolations
                };
            }, [rosters, matches, settings.minRestBetweenBouts]);
            
            // Drag handlers for inline drop
            const handleDragStart = (match, mat) => {
                setDragged(match);
                setDraggedFromMat(mat);
            };
            
            const handleDragEnd = () => {
                setDragged(null);
                setDraggedFromMat(null);
                setDropTarget({ mat: null, index: null });
            };
            
            const handleDragOverItem = (e, mat, index) => {
                e.preventDefault();
                e.stopPropagation();
                if (dragged) {
                    setDropTarget({ mat, index });
                }
            };
            
            const handleDragOverColumn = (e, mat) => {
                e.preventDefault();
                if (dragged && dropTarget.mat !== mat) {
                    const matMatches = matches.filter(m => m.mat === mat);
                    setDropTarget({ mat, index: matMatches.length });
                }
            };
            
            const handleDropOnItem = (e, mat, index) => {
                e.preventDefault();
                e.stopPropagation();
                if (dragged) {
                    moveMatchToPosition(dragged.num, mat, index);
                    handleDragEnd();
                }
            };
            
            const handleDropOnColumn = (e, mat) => {
                e.preventDefault();
                if (dragged) {
                    const matMatches = matches.filter(m => m.mat === mat);
                    moveMatchToPosition(dragged.num, mat, matMatches.length);
                    handleDragEnd();
                }
            };
            
            return (
                <div className="min-h-screen" style={{ backgroundColor: 'var(--md-sys-color-surface-container-low)' }}>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    <div className="max-w-7xl mx-auto p-4">
                        {/* Header */}
                        <header className="md-card-elevated p-6 mb-6 animate-slide-in">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div className="flex items-center gap-4">
                                    <span className="material-symbols-rounded filled" style={{ fontSize: '48px', color: 'var(--md-sys-color-primary)' }}>sports_kabaddi</span>
                                    <div>
                                        <h1 className="text-3xl font-bold" style={{ color: 'var(--md-sys-color-on-surface)' }}>Wrestling Match Maker Pro</h1>
                                        <p style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                            {currentTournament ? (
                                                <span className="flex items-center gap-2">
                                                    <span className="inline-block w-2 h-2 rounded-full animate-pulse" style={{ backgroundColor: 'var(--md-sys-color-tertiary)' }}></span>
                                                    {currentTournament} (auto-saving)
                                                </span>
                                            ) : 'Smart pairing for 2-4 team scrambles'}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={newTournament} className="md-outlined-button">
                                        <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>add</span>New
                                    </button>
                                    <button onClick={() => setShowSaveDialog(true)} className="md-outlined-button">
                                        <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>save</span>Save
                                    </button>
                                    {savedTournaments.length > 0 && (
                                        <>
                                            <select onChange={(e) => e.target.value && loadTournament(e.target.value)} className="md-text-field" style={{ width: 'auto', padding: '8px 16px' }}>
                                                <option value="">Load...</option>
                                                {savedTournaments.map(name => <option key={name} value={name}>{name}</option>)}
                                            </select>
                                            <button onClick={() => setShowManageDialog(true)} className="md-outlined-button">
                                                <span className="material-symbols-rounded">settings</span>
                                            </button>
                                        </>
                                    )}
                                    {matches.length > 0 && (
                                        <>
                                            <button onClick={() => setShowAnalytics(true)} className="md-filled-button">
                                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>analytics</span>Analytics
                                            </button>
                                            <button onClick={exportExcel} className="md-filled-button" style={{ backgroundColor: 'var(--md-sys-color-tertiary)' }}>
                                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>download</span>Export
                                            </button>
                                        </>
                                    )}
                                    {historyIndex > 0 && (
                                        <button onClick={undo} className="md-outlined-button" title="Undo (Ctrl+Z)">
                                            <span className="material-symbols-rounded">undo</span>
                                        </button>
                                    )}
                                    {historyIndex < history.length - 1 && (
                                        <button onClick={redo} className="md-outlined-button" title="Redo (Ctrl+Y)">
                                            <span className="material-symbols-rounded">redo</span>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </header>
                        
                        {/* Tabs */}
                        <div className="md-card mb-6 flex border-b" style={{ borderColor: 'var(--md-sys-color-outline-variant)' }}>
                            <button onClick={() => setTab('upload')} className={`tab-button ${tab === 'upload' ? 'active' : ''}`}>
                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>upload</span>Upload
                            </button>
                            <button onClick={() => setTab('settings')} className={`tab-button ${tab === 'settings' ? 'active' : ''}`}>
                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>tune</span>Settings
                            </button>
                            <button onClick={() => setTab('teams')} disabled={!matches.length} className={`tab-button ${tab === 'teams' ? 'active' : ''} ${!matches.length ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>groups</span>Teams {matches.length > 0 && `(${matches.length})`}
                            </button>
                            <button onClick={() => setTab('mats')} disabled={!matches.length} className={`tab-button ${tab === 'mats' ? 'active' : ''} ${!matches.length ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>sports_kabaddi</span>Mats
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="md-card-elevated p-6 animate-fade-in">
                            {tab === 'upload' && (
                                <div className="space-y-6">
                                    <div className="p-4 rounded-lg" style={{ backgroundColor: 'var(--md-sys-color-primary-container)', borderLeft: '4px solid var(--md-sys-color-primary)' }}>
                                        <p className="text-sm font-medium" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>
                                            <strong>Format:</strong> FirstName, LastName, Weight, DOB (MM/DD/YYYY), Experience (0-6), Skill (1-5)
                                        </p>
                                    </div>
                                    
                                    <div className="flex flex-wrap gap-3">
                                        <button onClick={() => setShowNameDialog(true)} className="md-filled-button">
                                            <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>edit</span>Edit Team Names
                                        </button>
                                        <button onClick={() => setShowManualDialog(true)} className="md-outlined-button">
                                            <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>person_add</span>Add Wrestler
                                        </button>
                                        <button onClick={() => setShowPasteDialog(true)} className="md-outlined-button">
                                            <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>content_paste</span>Paste Data
                                        </button>
                                        {scratched.length > 0 && (
                                            <button onClick={() => setShowScratchDialog(true)} className="md-outlined-button" style={{ borderColor: 'var(--md-sys-color-warning)', color: '#b45309' }}>
                                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>healing</span>Scratched ({scratched.length})
                                            </button>
                                        )}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        {['t1', 't2', 't3', 't4'].map(tk => (
                                            <div key={tk} className="md-card-outlined p-4">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="text-xl font-bold" style={{ color: rosters[tk].length > 0 ? colors[tk] : 'var(--md-sys-color-on-surface)' }}>
                                                        {names[tk]}
                                                    </h3>
                                                    <span className="md-chip">{rosters[tk].length}</span>
                                                </div>
                                                
                                                <label className="block cursor-pointer">
                                                    <div className="flex items-center justify-center px-6 py-4 rounded-xl border-2 border-dashed transition-all hover:border-[var(--md-sys-color-primary)]" style={{ borderColor: 'var(--md-sys-color-outline-variant)', backgroundColor: 'var(--md-sys-color-surface-container)' }}>
                                                        <span className="material-symbols-rounded" style={{ marginRight: '8px', color: 'var(--md-sys-color-primary)' }}>upload_file</span>
                                                        <span className="font-medium" style={{ color: 'var(--md-sys-color-primary)' }}>Upload CSV/Excel</span>
                                                    </div>
                                                    <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => loadFile(tk, e)} className="hidden" />
                                                </label>
                                                
                                                {rosters[tk].length > 0 && (
                                                    <div className="mt-4 space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                                        {rosters[tk].map((w, idx) => (
                                                            <div key={idx} className="wrestler-card p-3 rounded-lg flex justify-between items-center" style={{ backgroundColor: 'var(--md-sys-color-surface-container)', borderLeft: `3px solid ${colors[tk]}` }}>
                                                                <div>
                                                                    <div className="font-semibold" style={{ color: colors[tk] }}>{w.Name}</div>
                                                                    <div className="text-xs" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{w.Weight}lb • Age {w.Age} • Exp {w.Exp} • Skill {w.Skill}</div>
                                                                </div>
                                                                <div className="flex gap-1">
                                                                    <button onClick={() => openEditDialog(w, tk)} className="md-text-button p-1" title="Edit">
                                                                        <span className="material-symbols-rounded" style={{ fontSize: '18px' }}>edit</span>
                                                                    </button>
                                                                    <button onClick={() => scratchWrestler(w)} className="md-text-button p-1" title="Scratch">
                                                                        <span className="material-symbols-rounded" style={{ fontSize: '18px' }}>healing</span>
                                                                    </button>
                                                                    <button onClick={() => deleteWrestler(w, tk)} className="md-text-button p-1" title="Delete" style={{ color: 'var(--md-sys-color-error)' }}>
                                                                        <span className="material-symbols-rounded" style={{ fontSize: '18px' }}>delete</span>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <button onClick={generate} disabled={!total} className="w-full md-filled-button py-4 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span className="material-symbols-rounded filled" style={{ marginRight: '12px', fontSize: '24px' }}>auto_awesome</span>
                                        Generate Matchups ({total} wrestlers)
                                    </button>
                                </div>
                            )}
                            
                            {tab === 'settings' && (
                                <div className="max-w-4xl mx-auto space-y-8">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="block text-sm font-semibold mb-2">Max Weight Difference (%)</label>
                                            <input type="number" value={settings.maxWt} onChange={(e) => setSettings(p => ({ ...p, maxWt: parseFloat(e.target.value) }))} className="md-text-field" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2">Preferred Weight Difference (%)</label>
                                            <input type="number" value={settings.preferredWt} onChange={(e) => setSettings(p => ({ ...p, preferredWt: parseFloat(e.target.value) }))} className="md-text-field" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2">Max Age Difference (years)</label>
                                            <input type="number" value={settings.maxAge} onChange={(e) => setSettings(p => ({ ...p, maxAge: parseInt(e.target.value) }))} className="md-text-field" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2">Max Skill Difference</label>
                                            <input type="number" value={settings.maxSkill} onChange={(e) => setSettings(p => ({ ...p, maxSkill: parseInt(e.target.value) }))} className="md-text-field" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2">Min Matches per Wrestler</label>
                                            <input type="number" value={settings.minMatchesPerWrestler} onChange={(e) => setSettings(p => ({ ...p, minMatchesPerWrestler: parseInt(e.target.value) }))} className="md-text-field" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2">Max Matches per Mat</label>
                                            <input type="number" value={settings.maxPerMat} onChange={(e) => setSettings(p => ({ ...p, maxPerMat: parseInt(e.target.value) }))} className="md-text-field" />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-semibold mb-2">Min Rest Between Bouts</label>
                                            <input type="number" value={settings.minRestBetweenBouts} onChange={(e) => setSettings(p => ({ ...p, minRestBetweenBouts: parseInt(e.target.value) }))} className="md-text-field" />
                                            <p className="text-xs mt-1" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>Number of matches between bouts for adequate rest</p>
                                        </div>
                                    </div>
                                    
                                    <div className="p-6 rounded-xl" style={{ backgroundColor: 'var(--md-sys-color-primary-container)', borderLeft: '4px solid var(--md-sys-color-primary)' }}>
                                        <h3 className="font-bold text-lg mb-4" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>Current Rules Summary</h3>
                                        <ul className="space-y-2 text-sm" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>
                                            <li>Weight within {settings.maxWt}% (prefer {settings.preferredWt}%)</li>
                                            <li>Age within {settings.maxAge} year(s)</li>
                                            <li>Skill within {settings.maxSkill} points</li>
                                            <li>Each wrestler gets {settings.minMatchesPerWrestler}-3 matches</li>
                                            <li>Maximum {settings.maxPerMat} matches per mat</li>
                                            <li>Minimum {settings.minRestBetweenBouts} matches rest between bouts</li>
                                        </ul>
                                    </div>
                                </div>
                            )}
                            
                            {tab === 'teams' && matches.length > 0 && (
                                <div>
                                    <div className="flex gap-2 border-b mb-6 flex-wrap" style={{ borderColor: 'var(--md-sys-color-outline-variant)' }}>
                                        {['t1', 't2', 't3', 't4'].map(tk => rosters[tk].length > 0 && (
                                            <button key={tk} onClick={() => setTeamView(tk)} className={`tab-button ${teamView === tk ? 'active' : ''}`} style={teamView === tk ? { color: colors[tk] } : {}}>
                                                <span className="font-bold">{abbrevs[tk]}</span> - {names[tk]} ({rosters[tk].length})
                                            </button>
                                        ))}
                                    </div>
                                    
                                    <div className="mb-6 flex gap-4 flex-wrap">
                                        <input type="text" placeholder="Search wrestlers..." value={filterText} onChange={(e) => setFilterText(e.target.value)} className="md-text-field flex-1" />
                                        <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="md-text-field" style={{ width: 'auto' }}>
                                            <option value="name">Sort by Name</option>
                                            <option value="weight">Sort by Weight</option>
                                            <option value="skill">Sort by Skill</option>
                                            <option value="matches">Sort by Matches</option>
                                        </select>
                                    </div>
                                    
                                    <div className="grid grid-cols-12 gap-6">
                                        <div className="col-span-12 lg:col-span-5 space-y-2 overflow-y-auto custom-scrollbar" style={{ maxHeight: 'calc(100vh - 350px)' }}>
                                            {getFilteredRoster(teamView).map(w => {
                                                const ms = getMatches(w);
                                                const c = getColor(w.Team);
                                                return (
                                                    <div key={w.Name} className={`wrestler-card md-card-outlined p-3 cursor-pointer ${selected?.Name === w.Name ? 'ring-2' : ''}`} style={{ borderLeftColor: c, borderLeftWidth: '3px', ...(selected?.Name === w.Name ? { ringColor: 'var(--md-sys-color-primary)' } : {}) }}>
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex-1" onClick={() => setSelected(w)}>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-xs font-bold px-2 py-0.5 rounded" style={{ backgroundColor: c, color: 'white' }}>{getAbbrev(w.Team)}</span>
                                                                    <span className="font-bold" style={{ color: c }}>{w.Name}</span>
                                                                    <span className="text-xs" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{w.Weight}lb • {w.Age}y • E{w.Exp} • S{w.Skill}</span>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-lg font-bold" style={{ color: c }}>{ms.length}</span>
                                                                <button onClick={(e) => { e.stopPropagation(); scratchWrestler(w); }} className="text-red-600 hover:bg-red-50 rounded p-1" title="Scratch">X</button>
                                                            </div>
                                                        </div>
                                                        {ms.length > 0 && (
                                                            <div className="mt-2 space-y-1">
                                                                {ms.map(m => {
                                                                    const opp = m.w1.Name === w.Name ? m.w2 : m.w1;
                                                                    const oc = getColor(opp.Team);
                                                                    return (
                                                                        <div key={m.num} className="text-xs p-1.5 rounded" style={{ backgroundColor: oc + '15', borderLeft: `2px solid ${oc}` }}>
                                                                            <div className="flex items-center justify-between mb-1">
                                                                                <div className="flex items-center gap-1">
                                                                                    <span className="font-mono font-semibold">#{m.num}</span>
                                                                                    <span className="px-1 py-0.5 rounded text-white" style={{ backgroundColor: oc }}>{getAbbrev(opp.Team)}</span>
                                                                                    <span className="font-semibold truncate" style={{ color: oc }}>{opp.Name}</span>
                                                                                    <span className="text-xs font-bold px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-700">{getMatches(opp).length}</span>
                                                                                </div>
                                                                                <button onClick={(e) => { e.stopPropagation(); delMatch(m.num); }} className="text-red-600 hover:bg-red-100 rounded px-1">X</button>
                                                                            </div>
                                                                            <StatsCompare w1={w} w2={opp} compact={true} />
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        
                                        <div className="col-span-12 lg:col-span-7">
                                            {selected ? (
                                                <div className="space-y-4">
                                                    <div className="p-4 rounded-xl" style={{ backgroundColor: 'var(--md-sys-color-primary-container)' }}>
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="font-bold text-lg" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>
                                                                    <span className="material-symbols-rounded" style={{ marginRight: '8px', verticalAlign: 'middle' }}>sports_kabaddi</span>
                                                                    Suggested Opponents for {selected.Name}
                                                                </h3>
                                                                <p className="text-sm" style={{ color: 'var(--md-sys-color-on-primary-container)' }}>Click to add match • Sorted by fewest matches first</p>
                                                            </div>
                                                            <button onClick={() => setShowSearchOpponent(true)} className="md-outlined-button" style={{ borderColor: 'var(--md-sys-color-on-primary-container)', color: 'var(--md-sys-color-on-primary-container)' }}>
                                                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>search</span>Search All
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Show warning if expanded criteria are being used */}
                                                    {getMatches(selected).length === 0 && getSuggestions(selected).some(s => s.expanded) && (
                                                        <div className="p-3 rounded-lg flex items-center gap-2" style={{ backgroundColor: 'var(--md-sys-color-warning-container)', border: '1px solid var(--md-sys-color-warning)' }}>
                                                            <span className="material-symbols-rounded" style={{ color: '#b45309' }}>warning</span>
                                                            <span className="text-sm font-medium" style={{ color: '#b45309' }}>
                                                                No matches within normal criteria. Showing expanded options (2x limits) - use with caution.
                                                            </span>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="space-y-3 max-h-[500px] overflow-y-auto custom-scrollbar">
                                                        {getSuggestions(selected).map(({ w, wtPct, ageDiff, expDiff, skillDiff, expanded, matchCount }) => {
                                                            const c = getColor(w.Team);
                                                            return (
                                                                <div key={w.Name} onClick={() => addMatch(selected, w)} className={`match-card md-card-outlined p-4 cursor-pointer hover:shadow-lg ${expanded ? 'ring-2 ring-orange-400' : ''}`} style={expanded ? { backgroundColor: 'var(--md-sys-color-warning-container)' } : {}}>
                                                                    <div className="flex items-center gap-2 mb-2">
                                                                        {expanded && <span className="material-symbols-rounded text-orange-500" style={{ fontSize: '18px' }}>warning</span>}
                                                                        <span className="text-xs font-bold px-2 py-0.5 rounded" style={{ backgroundColor: c, color: 'white' }}>{getAbbrev(w.Team)}</span>
                                                                        <span className="font-bold text-lg" style={{ color: c }}>{w.Name}</span>
                                                                        <span className={`text-sm font-bold px-2 py-0.5 rounded-full ${matchCount === 0 ? 'bg-red-100 text-red-700' : matchCount < 2 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-200 text-gray-700'}`}>{matchCount} {matchCount === 1 ? 'match' : 'matches'}</span>
                                                                    </div>
                                                                    <StatsCompare w1={selected} w2={w} compact={false} />
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="h-full flex items-center justify-center" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                                    <div className="text-center">
                                                        <span className="material-symbols-rounded" style={{ fontSize: '64px' }}>arrow_back</span>
                                                        <p className="text-lg mt-4">Select a wrestler to manage matchups</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tab === 'mats' && matches.length > 0 && (
                                <div>
                                    <div className="mb-3 p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: 'var(--md-sys-color-warning-container)' }}>
                                        <span className="material-symbols-rounded" style={{ color: '#b45309', fontSize: '18px' }}>warning</span>
                                        <span className="text-xs" style={{ color: '#b45309' }}>Orange = rest violation. Drag to reorder or move between mats.</span>
                                    </div>
                                    
                                    {/* Unified scroll container for all mats */}
                                    <div className="overflow-y-auto custom-scrollbar" style={{ maxHeight: 'calc(100vh - 280px)' }}>
                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
                                            {[1, 2, 3].map(mat => {
                                                const ms = matches.filter(m => m.mat === mat).sort((a, b) => a.order - b.order);
                                                const isColumnDragOver = dragged && dropTarget.mat === mat;
                                                
                                                return (
                                                    <div 
                                                        key={mat} 
                                                        className={`mat-column md-card overflow-hidden ${isColumnDragOver ? 'drag-over' : ''}`}
                                                        onDragOver={(e) => handleDragOverColumn(e, mat)}
                                                        onDrop={(e) => handleDropOnColumn(e, mat)}
                                                    >
                                                        <div className="px-3 py-2 flex justify-between items-center sticky top-0 z-10" style={{ backgroundColor: 'var(--md-sys-color-primary)', color: 'var(--md-sys-color-on-primary)' }}>
                                                            <h3 className="font-bold flex items-center gap-1 text-sm">
                                                                <span className="material-symbols-rounded filled" style={{ fontSize: '16px' }}>sports_kabaddi</span>
                                                                Mat {mat}
                                                            </h3>
                                                            <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: 'rgba(255,255,255,0.2)' }}>{ms.length}</span>
                                                        </div>
                                                        
                                                        <div className="p-2 space-y-1" style={{ backgroundColor: 'var(--md-sys-color-surface-container)' }}>
                                                            {ms.map((m, index) => {
                                                                const c1 = getColor(m.w1.Team);
                                                                const c2 = getColor(m.w2.Team);
                                                                const w1NeedsRest = needsRestHighlight(m.w1, m.num, mat);
                                                                const w2NeedsRest = needsRestHighlight(m.w2, m.num, mat);
                                                                const anyNeedsRest = w1NeedsRest || w2NeedsRest;
                                                                const isDropHere = dropTarget.mat === mat && dropTarget.index === index;
                                                                const isDragging = dragged?.num === m.num;
                                                                
                                                                return (
                                                                    <React.Fragment key={m.num}>
                                                                        {/* Drop indicator */}
                                                                        <div 
                                                                            className={`drop-indicator ${isDropHere ? 'active' : ''}`}
                                                                            onDragOver={(e) => handleDragOverItem(e, mat, index)}
                                                                            onDrop={(e) => handleDropOnItem(e, mat, index)}
                                                                        />
                                                                        
                                                                        {/* Compact match card */}
                                                                        <div 
                                                                            draggable
                                                                            onDragStart={() => handleDragStart(m, mat)}
                                                                            onDragEnd={handleDragEnd}
                                                                            className={`match-card rounded p-1.5 cursor-move ${anyNeedsRest ? 'ring-1 ring-orange-400' : ''} ${isDragging ? 'dragging' : ''}`}
                                                                            style={{ backgroundColor: 'var(--md-sys-color-surface)', boxShadow: 'var(--md-sys-elevation-1)' }}
                                                                        >
                                                                            {/* Single row: # | W1 | vs | W2 | stats */}
                                                                            <div className="flex items-center gap-1 text-xs">
                                                                                <span className="material-symbols-rounded" style={{ color: 'var(--md-sys-color-outline)', fontSize: '12px' }}>drag_indicator</span>
                                                                                <span className="font-mono font-bold text-gray-600 w-7">#{m.num % 100}</span>
                                                                                
                                                                                {/* Wrestler 1 */}
                                                                                <div className={`flex items-center gap-0.5 flex-1 min-w-0 px-1 py-0.5 rounded ${w1NeedsRest ? 'ring-1 ring-orange-400' : ''}`} style={{ backgroundColor: c1 + '15' }}>
                                                                                    <span className="font-bold px-1 rounded text-white" style={{ backgroundColor: c1, fontSize: '9px' }}>{getAbbrev(m.w1.Team)}</span>
                                                                                    <span className="truncate font-medium" style={{ color: c1 }}>{m.w1.LastName || m.w1.Name.split(' ')[1] || m.w1.Name}</span>
                                                                                    <span className="text-gray-500">{m.w1.Weight}</span>
                                                                                </div>
                                                                                
                                                                                <span className="text-gray-400 font-bold">vs</span>
                                                                                
                                                                                {/* Wrestler 2 */}
                                                                                <div className={`flex items-center gap-0.5 flex-1 min-w-0 px-1 py-0.5 rounded ${w2NeedsRest ? 'ring-1 ring-orange-400' : ''}`} style={{ backgroundColor: c2 + '15' }}>
                                                                                    <span className="font-bold px-1 rounded text-white" style={{ backgroundColor: c2, fontSize: '9px' }}>{getAbbrev(m.w2.Team)}</span>
                                                                                    <span className="truncate font-medium" style={{ color: c2 }}>{m.w2.LastName || m.w2.Name.split(' ')[1] || m.w2.Name}</span>
                                                                                    <span className="text-gray-500">{m.w2.Weight}</span>
                                                                                </div>
                                                                                
                                                                                {/* Compact stats */}
                                                                                <span className={`px-1 py-0.5 rounded font-semibold ${m.wtPct <= 5 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`} style={{ fontSize: '9px' }}>
                                                                                    {m.wtPct.toFixed(0)}%
                                                                                </span>
                                                                                <span className="px-1 py-0.5 rounded font-semibold bg-purple-100 text-purple-800" style={{ fontSize: '9px' }} title="Average Skill">
                                                                                    S{((m.w1.Skill + m.w2.Skill) / 2).toFixed(1)}
                                                                                </span>
                                                                                {anyNeedsRest && <span className="material-symbols-rounded text-orange-500" style={{ fontSize: '12px' }}>warning</span>}
                                                                            </div>
                                                                        </div>
                                                                    </React.Fragment>
                                                                );
                                                            })}
                                                            
                                                            {/* Drop indicator at end */}
                                                            <div 
                                                                className={`drop-indicator ${dropTarget.mat === mat && dropTarget.index === ms.length ? 'active' : ''}`}
                                                                onDragOver={(e) => handleDragOverItem(e, mat, ms.length)}
                                                                onDrop={(e) => handleDropOnItem(e, mat, ms.length)}
                                                            />
                                                            
                                                            {ms.length === 0 && (
                                                                <div className="text-center py-6" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                                                    <span className="material-symbols-rounded" style={{ fontSize: '32px' }}>inbox</span>
                                                                    <p className="text-xs mt-1">Drag matches here</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Modals */}
                    <Modal isOpen={showSaveDialog} onClose={() => setShowSaveDialog(false)} title="Save Tournament" size="sm">
                        <input type="text" value={saveName} onChange={(e) => setSaveName(e.target.value)} placeholder="Tournament name" className="md-text-field mb-4" autoFocus onKeyPress={(e) => e.key === 'Enter' && saveNew()} />
                        <div className="flex gap-3">
                            <button onClick={saveNew} className="flex-1 md-filled-button">Save</button>
                            <button onClick={() => { setShowSaveDialog(false); setSaveName(''); }} className="flex-1 md-outlined-button">Cancel</button>
                        </div>
                    </Modal>
                    
                    <Modal isOpen={showManageDialog} onClose={() => setShowManageDialog(false)} title="Manage Tournaments" size="md">
                        {savedTournaments.length === 0 ? (
                            <p className="text-center py-8" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>No saved tournaments yet.</p>
                        ) : (
                            <div className="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                                {savedTournaments.map(name => {
                                    const saved = JSON.parse(localStorage.getItem('wrestlingTournaments') || '{}');
                                    const lastMod = saved[name]?.lastModified ? new Date(saved[name].lastModified).toLocaleDateString() : 'Unknown';
                                    return (
                                        <div key={name} className="flex justify-between items-center p-4 md-card-outlined">
                                            <div>
                                                <div className="font-semibold text-lg">{name}</div>
                                                <div className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>Last modified: {lastMod}</div>
                                            </div>
                                            <button onClick={() => deleteTournament(name)} className="md-filled-button" style={{ backgroundColor: 'var(--md-sys-color-error)' }}>Delete</button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </Modal>
                    
                    <Modal isOpen={showNameDialog} onClose={() => setShowNameDialog(false)} title="Edit Team Names" size="md">
                        <div className="space-y-6">
                            {['t1', 't2', 't3', 't4'].map(tk => (
                                <div key={tk} className="flex items-center gap-4">
                                    <input type="color" value={colors[tk]} onChange={(e) => setColors(p => ({ ...p, [tk]: e.target.value }))} className="w-12 h-12 rounded-lg cursor-pointer border-2" style={{ borderColor: 'var(--md-sys-color-outline-variant)' }} />
                                    <div className="flex-1">
                                        <label className="block text-sm font-semibold mb-1" style={{ color: colors[tk] }}>Team {tk.replace('t', '')} Name</label>
                                        <input type="text" value={names[tk]} onChange={(e) => handleTeamNameChange(tk, e.target.value)} className="md-text-field" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>Abbrev</label>
                                        <input type="text" value={abbrevs[tk]} onChange={(e) => setAbbrevs(p => ({ ...p, [tk]: e.target.value.substring(0, 3).toUpperCase() }))} className="md-text-field w-20 text-center" maxLength="3" />
                                    </div>
                                </div>
                            ))}
                            <button onClick={() => setShowNameDialog(false)} className="w-full md-filled-button">Done</button>
                        </div>
                    </Modal>
                    
                    <Modal isOpen={showManualDialog} onClose={() => setShowManualDialog(false)} title="Add Wrestler" size="md">
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block font-semibold mb-2">First Name *</label>
                                    <input type="text" value={manualData.firstName} onChange={(e) => setManualData(p => ({ ...p, firstName: e.target.value }))} className="md-text-field" />
                                </div>
                                <div>
                                    <label className="block font-semibold mb-2">Last Name *</label>
                                    <input type="text" value={manualData.lastName} onChange={(e) => setManualData(p => ({ ...p, lastName: e.target.value }))} className="md-text-field" />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block font-semibold mb-2">Weight (lbs) *</label>
                                    <input type="number" value={manualData.weight} onChange={(e) => setManualData(p => ({ ...p, weight: e.target.value }))} className="md-text-field" />
                                </div>
                                <div>
                                    <label className="block font-semibold mb-2">Date of Birth *</label>
                                    <input type="date" value={manualData.dob} onChange={(e) => setManualData(p => ({ ...p, dob: e.target.value }))} className="md-text-field" />
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="block font-semibold mb-2">Experience (0-6)</label>
                                    <select value={manualData.exp} onChange={(e) => setManualData(p => ({ ...p, exp: e.target.value }))} className="md-text-field">
                                        {[0,1,2,3,4,5,6].map(n => <option key={n} value={n}>{n} {n === 1 ? 'year' : 'years'}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block font-semibold mb-2">Skill (1-5)</label>
                                    <select value={manualData.skill} onChange={(e) => setManualData(p => ({ ...p, skill: e.target.value }))} className="md-text-field">
                                        {[1,2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block font-semibold mb-2">Team</label>
                                    <select value={manualData.team} onChange={(e) => setManualData(p => ({ ...p, team: e.target.value }))} className="md-text-field">
                                        <option value="t1">{names.t1}</option>
                                        <option value="t2">{names.t2}</option>
                                        <option value="t3">{names.t3}</option>
                                        <option value="t4">{names.t4}</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button onClick={handleManualAdd} className="flex-1 md-filled-button">Add Wrestler</button>
                                <button onClick={() => setShowManualDialog(false)} className="flex-1 md-outlined-button">Cancel</button>
                            </div>
                        </div>
                    </Modal>
                    
                    <Modal isOpen={showPasteDialog} onClose={() => setShowPasteDialog(false)} title="Paste Roster Data" size="lg">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold mb-2">Select Team</label>
                                <select value={pasteTeam} onChange={(e) => setPasteTeam(e.target.value)} className="md-text-field">
                                    <option value="t1">{names.t1}</option>
                                    <option value="t2">{names.t2}</option>
                                    <option value="t3">{names.t3}</option>
                                    <option value="t4">{names.t4}</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2">Paste Data (FirstName, LastName, Weight, DOB, Exp (0-6), Skill (1-5))</label>
                                <textarea value={pasteText} onChange={(e) => setPasteText(e.target.value)} className="md-text-field h-64 font-mono text-sm" placeholder="John,Doe,150,01/15/2010,2,3&#10;Jane,Smith,145,03/20/2011,0,2" />
                            </div>
                            <div className="flex gap-3">
                                <button onClick={handlePaste} className="flex-1 md-filled-button">Import</button>
                                <button onClick={() => { setShowPasteDialog(false); setPasteText(''); }} className="flex-1 md-outlined-button">Cancel</button>
                            </div>
                        </div>
                    </Modal>
                    
                    <Modal isOpen={showScratchDialog} onClose={() => setShowScratchDialog(false)} title="Scratched Wrestlers" size="md">
                        <p className="text-sm mb-4" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>These wrestlers were removed from the tournament. Click "Restore" to add them back.</p>
                        {scratched.length === 0 ? (
                            <p className="text-center py-8" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>No scratched wrestlers.</p>
                        ) : (
                            <div className="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                                {scratched.map((w, idx) => {
                                    const c = getColor(w.Team);
                                    return (
                                        <div key={idx} className="flex justify-between items-center p-4 md-card-outlined" style={{ borderLeftColor: c, borderLeftWidth: '4px' }}>
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-xs font-bold px-2 py-0.5 rounded" style={{ backgroundColor: c, color: 'white' }}>{getAbbrev(w.Team)}</span>
                                                    <div className="font-semibold text-lg" style={{ color: c }}>{w.Name}</div>
                                                </div>
                                                <div className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>{w.Weight} lbs • Age {w.Age} • Exp {w.Exp} • Skill {w.Skill}</div>
                                            </div>
                                            <button onClick={() => restoreWrestler(w)} className="md-filled-button" style={{ backgroundColor: 'var(--md-sys-color-tertiary)' }}>
                                                <span className="material-symbols-rounded" style={{ marginRight: '8px' }}>restore</span>Restore
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </Modal>
                    
                    <Modal isOpen={showAnalytics} onClose={() => setShowAnalytics(false)} title="Tournament Analytics" size="xl">
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <StatCard title="Total Wrestlers" value={analytics.totalWrestlers} icon="groups" color="blue" />
                                <StatCard title="Total Matches" value={analytics.totalMatches} icon="sports_kabaddi" color="purple" />
                                <StatCard title="Avg Matches/Wrestler" value={analytics.avgMatchesPerWrestler} icon="bar_chart" color="green" />
                                <StatCard title="Rest Violations" value={analytics.restViolations} icon="warning" color="orange" />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="md-card p-6">
                                    <h3 className="font-bold text-lg mb-4">Match Distribution</h3>
                                    <div className="space-y-3">
                                        {Object.entries(analytics.distribution).map(([count, wrestlers]) => (
                                            <div key={count} className="flex justify-between items-center">
                                                <span className="font-medium">{count} matches:</span>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-48 h-4 overflow-hidden rounded-full" style={{ backgroundColor: 'var(--md-sys-color-surface-container-highest)' }}>
                                                        <div className="h-full rounded-full transition-all" style={{ width: `${(wrestlers / analytics.totalWrestlers) * 100}%`, backgroundColor: 'var(--md-sys-color-primary)' }}></div>
                                                    </div>
                                                    <span className="font-bold w-12 text-right">{wrestlers}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="md-card p-6">
                                    <h3 className="font-bold text-lg mb-4">Mat Distribution</h3>
                                    <div className="space-y-3">
                                        {[1, 2, 3].map(mat => (
                                            <div key={mat} className="flex justify-between items-center">
                                                <span className="font-medium">Mat {mat}:</span>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-48 h-4 overflow-hidden rounded-full" style={{ backgroundColor: 'var(--md-sys-color-surface-container-highest)' }}>
                                                        <div className="h-full rounded-full transition-all" style={{ width: `${analytics.totalMatches > 0 ? (analytics.matCounts[mat] / analytics.totalMatches) * 100 : 0}%`, backgroundColor: 'var(--md-sys-color-tertiary)' }}></div>
                                                    </div>
                                                    <span className="font-bold w-12 text-right">{analytics.matCounts[mat]}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* Edit Wrestler Modal */}
                    <Modal isOpen={showEditDialog} onClose={() => { setShowEditDialog(false); setEditData(null); }} title="Edit Wrestler" size="md">
                        {editData && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block font-semibold mb-2">First Name *</label>
                                        <input type="text" value={editData.firstName} onChange={(e) => setEditData(p => ({ ...p, firstName: e.target.value }))} className="md-text-field" />
                                    </div>
                                    <div>
                                        <label className="block font-semibold mb-2">Last Name *</label>
                                        <input type="text" value={editData.lastName} onChange={(e) => setEditData(p => ({ ...p, lastName: e.target.value }))} className="md-text-field" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block font-semibold mb-2">Weight (lbs) *</label>
                                        <input type="number" value={editData.weight} onChange={(e) => setEditData(p => ({ ...p, weight: e.target.value }))} className="md-text-field" />
                                    </div>
                                    <div>
                                        <label className="block font-semibold mb-2">Date of Birth *</label>
                                        <input type="date" value={editData.dob} onChange={(e) => setEditData(p => ({ ...p, dob: e.target.value }))} className="md-text-field" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block font-semibold mb-2">Experience (0-6)</label>
                                        <select value={editData.exp} onChange={(e) => setEditData(p => ({ ...p, exp: e.target.value }))} className="md-text-field">
                                            {[0,1,2,3,4,5,6].map(n => <option key={n} value={n}>{n} {n === 1 ? 'year' : 'years'}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block font-semibold mb-2">Skill (1-5)</label>
                                        <select value={editData.skill} onChange={(e) => setEditData(p => ({ ...p, skill: e.target.value }))} className="md-text-field">
                                            {[1,2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="flex gap-3 pt-4">
                                    <button onClick={handleEditSave} className="flex-1 md-filled-button">Save Changes</button>
                                    <button onClick={() => { setShowEditDialog(false); setEditData(null); }} className="flex-1 md-outlined-button">Cancel</button>
                                </div>
                            </div>
                        )}
                    </Modal>
                    
                    {/* Search Opponent Modal */}
                    <Modal isOpen={showSearchOpponent} onClose={() => { setShowSearchOpponent(false); setOpponentSearch(''); }} title={`Search Opponent for ${selected?.Name || ''}`} size="lg">
                        <div className="space-y-4">
                            <div className="p-3 rounded-lg" style={{ backgroundColor: 'var(--md-sys-color-surface-container)' }}>
                                <p className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                    Search by name or weight to find any wrestler from other teams. Results show match compatibility even if outside normal criteria.
                                </p>
                            </div>
                            
                            <input 
                                type="text" 
                                value={opponentSearch} 
                                onChange={(e) => setOpponentSearch(e.target.value)} 
                                placeholder="Search by name or weight..." 
                                className="md-text-field" 
                                autoFocus 
                            />
                            
                            {opponentSearch.length >= 2 && selected && (
                                <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar">
                                    {searchAllOpponents(selected, opponentSearch).map(({ w, wtPct, ageDiff, expDiff, skillDiff, expanded, outsideCriteria, matchCount }) => {
                                        const c = getColor(w.Team);
                                        return (
                                            <div 
                                                key={`${w.Name}-${w.Team}`} 
                                                onClick={() => addMatch(selected, w)} 
                                                className={`match-card md-card-outlined p-4 cursor-pointer hover:shadow-lg ${outsideCriteria ? 'ring-2 ring-red-400' : expanded ? 'ring-2 ring-orange-400' : ''}`} 
                                                style={outsideCriteria ? { backgroundColor: 'var(--md-sys-color-error-container)' } : expanded ? { backgroundColor: 'var(--md-sys-color-warning-container)' } : {}}
                                            >
                                                <div className="flex items-center gap-2 mb-2">
                                                    {outsideCriteria && <span className="material-symbols-rounded text-red-500" style={{ fontSize: '18px' }}>error</span>}
                                                    {expanded && !outsideCriteria && <span className="material-symbols-rounded text-orange-500" style={{ fontSize: '18px' }}>warning</span>}
                                                    <span className="text-xs font-bold px-2 py-0.5 rounded" style={{ backgroundColor: c, color: 'white' }}>{getAbbrev(w.Team)}</span>
                                                    <span className="font-bold text-lg" style={{ color: c }}>{w.Name}</span>
                                                    <span className={`text-sm font-bold px-2 py-0.5 rounded-full ${matchCount === 0 ? 'bg-red-100 text-red-700' : matchCount < 2 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-200 text-gray-700'}`}>{matchCount} {matchCount === 1 ? 'match' : 'matches'}</span>
                                                    {outsideCriteria && <span className="text-xs text-red-600 font-medium">Outside all criteria</span>}
                                                    {expanded && !outsideCriteria && <span className="text-xs text-orange-600 font-medium">Expanded criteria</span>}
                                                </div>
                                                <StatsCompare w1={selected} w2={w} compact={false} />
                                            </div>
                                        );
                                    })}
                                    {searchAllOpponents(selected, opponentSearch).length === 0 && (
                                        <p className="text-center py-4" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>No wrestlers found matching "{opponentSearch}"</p>
                                    )}
                                </div>
                            )}
                            
                            {opponentSearch.length < 2 && (
                                <p className="text-center py-8" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                    Type at least 2 characters to search
                                </p>
                            )}
                        </div>
                    </Modal>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
